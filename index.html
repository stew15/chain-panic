<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>CHAIN PANIC</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html,body { width:100%; height:100%; background:#000; overflow:hidden; touch-action:none; -webkit-tap-highlight-color:transparent; font-family:'Courier New',monospace; }
canvas { display:block; position:fixed; top:0; left:0; }

#share-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:100; align-items:center; justify-content:center; flex-direction:column; gap:12px; }
#share-modal.show { display:flex; }
#share-canvas { border-radius:14px; max-width:88vw; box-shadow:0 0 40px #00ffff44; }
#video-wrap { display:none; position:relative; max-width:88vw; }
#share-video  { border-radius:14px; max-width:100%; max-height:40vh; box-shadow:0 0 40px #ff006644; display:block; }

.sbtn { padding:12px 24px; border:none; border-radius:40px; font-size:12px; font-weight:bold; letter-spacing:2px; cursor:pointer; text-transform:uppercase; font-family:'Courier New',monospace; transition:transform 0.1s,box-shadow 0.1s; }
.sbtn:active { transform:scale(0.95); }
#btn-sn   { background:rgba(0,255,255,0.1); color:#00ffff; border:1.5px solid rgba(0,255,255,0.7); text-shadow:0 0 10px #00ffff; box-shadow:0 0 16px rgba(0,255,255,0.35); position:relative; overflow:hidden; }
#btn-sn::before { content:''; position:absolute; top:0; left:0; height:100%; width:0; background:rgba(0,255,255,0.25); pointer-events:none; transition:width 0.3s ease; }
#btn-sn span { position:relative; z-index:1; }
#btn-sn.ready::before { width:100%; }
#btn-sn:active { box-shadow:0 0 28px rgba(0,255,255,0.65); }
#btn-copy { background:transparent; color:rgba(255,255,255,0.5); border:1px solid rgba(255,255,255,0.2); font-size:11px; }
#btn-cl   { background:transparent; color:rgba(255,255,255,0.35); border:1px solid rgba(255,255,255,0.12); font-size:11px; }
.srow     { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }

#auth-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.96); z-index:200; align-items:center; justify-content:center; flex-direction:column; gap:16px; }
#auth-modal.show { display:flex; }
.auth-title { font-size:20px; font-weight:bold; color:#fff; letter-spacing:3px; text-shadow:0 0 20px #00ffff; }
.auth-sub   { font-size:12px; color:rgba(255,255,255,0.45); letter-spacing:1px; text-align:center; max-width:270px; line-height:1.6; }
#btn-google { display:flex; align-items:center; gap:10px; background:#fff; color:#333; padding:13px 26px; border-radius:40px; font-size:14px; font-weight:bold; border:none; cursor:pointer; letter-spacing:1px; transition:transform 0.1s; }
#btn-google:active { transform:scale(0.97); }
#btn-auth-close { background:transparent; color:#444; border:1px solid #333; font-size:11px; padding:10px 20px; margin-top:4px; }

#how-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.94); z-index:150; align-items:center; justify-content:center; flex-direction:column; gap:0; }
#how-modal.show { display:flex; }
#how-box { background:#07070e; border:1px solid rgba(0,255,255,0.35); border-radius:16px; padding:20px 20px 16px; max-width:340px; width:90vw; max-height:88vh; display:flex; flex-direction:column; }
#how-box h2 { color:#00ffff; text-shadow:0 0 12px #00ffff; letter-spacing:3px; font-size:15px; text-align:center; margin-bottom:12px; flex-shrink:0; }
#how-rows { overflow-y:auto; flex:1; }
.how-row { display:flex; gap:10px; align-items:flex-start; margin-bottom:10px; }
.how-icon { font-size:18px; flex-shrink:0; margin-top:1px; }
.how-text { font-size:11px; color:rgba(255,255,255,0.75); line-height:1.5; letter-spacing:0.4px; }
.how-text b { color:#fff; }
#btn-how-close { margin-top:12px; width:100%; padding:11px; background:rgba(0,255,255,0.1); color:#00ffff; border:1.5px solid rgba(0,255,255,0.6); border-radius:30px; font-weight:bold; font-size:12px; letter-spacing:2px; cursor:pointer; font-family:'Courier New',monospace; text-shadow:0 0 8px #00ffff; flex-shrink:0; }

#user-badge { display:none; position:fixed; top:14px; left:14px; z-index:50; align-items:center; justify-content:center; background:rgba(0,255,255,0.08); border:1px solid rgba(0,255,255,0.45); border-radius:20px; padding:7px 14px; cursor:pointer; box-shadow:0 0 10px rgba(0,255,255,0.25); transition:all 0.12s; }
#user-badge.show { display:flex; }
#user-badge:active { background:rgba(0,255,255,0.18); box-shadow:0 0 18px rgba(0,255,255,0.55); }
#user-avatar { width:24px; height:24px; border-radius:50%; object-fit:cover; background:#222; }
#user-name { font-size:10px; color:#00ffff; letter-spacing:2px; font-family:'Courier New',monospace; font-weight:bold; text-shadow:0 0 10px #00ffff,0 0 20px rgba(0,255,255,0.4); text-align:center; }
#btn-login   { display:none; position:fixed; top:14px; left:14px; z-index:50; background:rgba(0,255,255,0.1); border:1px solid rgba(0,255,255,0.3); color:rgba(0,255,255,0.9); font-size:10px; padding:7px 13px; border-radius:20px; cursor:pointer; letter-spacing:1px; font-family:'Courier New',monospace; font-weight:bold; }
#btn-login.show { display:block; }
#btn-pause   { display:none; position:fixed; top:14px; right:14px; z-index:50; background:rgba(0,255,255,0.08); border:1px solid rgba(0,255,255,0.45); color:#00ffff; font-size:10px; padding:7px 14px; border-radius:20px; cursor:pointer; letter-spacing:2px; font-family:'Courier New',monospace; font-weight:bold; text-shadow:0 0 10px #00ffff,0 0 20px rgba(0,255,255,0.4); box-shadow:0 0 10px rgba(0,255,255,0.25); transition:all 0.12s; }
#btn-pause.show { display:block; }
#btn-pause:active { background:rgba(0,255,255,0.18); box-shadow:0 0 18px rgba(0,255,255,0.55); }
#btn-sn.loading { cursor:not-allowed; color:rgba(0,255,255,0.45); border-color:rgba(0,255,255,0.3); }
#btn-sn.loading::before { animation:fillup 9s linear forwards; }
@keyframes fillup { from { width:0; } to { width:100%; } }

/* ‚îÄ‚îÄ Auth form ‚îÄ‚îÄ */
.auth-form { display:flex; flex-direction:column; gap:10px; width:280px; }
.auth-inp { background:rgba(0,255,255,0.05); border:1px solid rgba(0,255,255,0.25); color:#fff; padding:11px 14px; border-radius:8px; font-size:13px; font-family:'Courier New',monospace; letter-spacing:1px; outline:none; }
.auth-inp:focus { border-color:rgba(0,255,255,0.7); box-shadow:0 0 10px rgba(0,255,255,0.15); }
.auth-inp::placeholder { color:rgba(255,255,255,0.25); }
.auth-tabs { display:flex; width:280px; margin-bottom:4px; }
.auth-tab { flex:1; padding:10px; background:transparent; border:1px solid rgba(0,255,255,0.2); color:rgba(255,255,255,0.35); font-family:'Courier New',monospace; font-size:11px; letter-spacing:2px; cursor:pointer; }
.auth-tab:first-child { border-radius:8px 0 0 8px; }
.auth-tab:last-child { border-radius:0 8px 8px 0; }
.auth-tab.active { background:rgba(0,255,255,0.12); color:#00ffff; border-color:rgba(0,255,255,0.5); text-shadow:0 0 8px #00ffff; }
.auth-btn { background:rgba(0,255,255,0.12); color:#00ffff; border:1.5px solid rgba(0,255,255,0.55); padding:12px; border-radius:8px; font-family:'Courier New',monospace; font-size:12px; font-weight:bold; letter-spacing:2px; cursor:pointer; text-shadow:0 0 8px #00ffff; margin-top:4px; }
.auth-btn:active { background:rgba(0,255,255,0.25); }
.auth-msg { font-size:11px; letter-spacing:0.5px; text-align:center; min-height:16px; line-height:1.5; max-width:280px; }
.auth-msg.err { color:#ff5555; }
.auth-msg.ok  { color:#00ff88; }
.auth-link { background:transparent; border:none; color:rgba(255,255,255,0.3); font-size:10px; font-family:'Courier New',monospace; cursor:pointer; letter-spacing:1px; text-decoration:underline; }

/* ‚îÄ‚îÄ Settings modal ‚îÄ‚îÄ */
#settings-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.96); z-index:200; align-items:center; justify-content:center; flex-direction:column; gap:0; }
#settings-modal.show { display:flex; }
.settings-box { background:#07070e; border:1px solid rgba(0,255,255,0.35); border-radius:16px; padding:26px 26px 20px; width:300px; display:flex; flex-direction:column; gap:22px; }
.settings-title { color:#00ffff; text-shadow:0 0 12px #00ffff; letter-spacing:3px; font-size:14px; text-align:center; }
.settings-row { display:flex; flex-direction:column; gap:8px; }
.settings-lbl { font-size:10px; color:rgba(255,255,255,0.45); letter-spacing:2px; display:flex; justify-content:space-between; }
.settings-lbl span { color:#00ffff; }
input[type=range] { -webkit-appearance:none; width:100%; height:4px; border-radius:2px; background:rgba(0,255,255,0.15); outline:none; cursor:pointer; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:#00ffff; box-shadow:0 0 8px #00ffff; cursor:pointer; }
.settings-section { display:flex; flex-direction:column; gap:6px; border-top:1px solid rgba(255,255,255,0.06); padding-top:16px; }
.settings-user { font-size:11px; color:rgba(255,255,255,0.5); letter-spacing:1px; text-align:center; }
.settings-user b { color:#fff; }
#btn-signout { background:transparent; color:rgba(255,80,80,0.7); border:1px solid rgba(255,80,80,0.3); padding:9px; border-radius:8px; font-family:'Courier New',monospace; font-size:10px; letter-spacing:2px; cursor:pointer; width:100%; }
#btn-settings-close { background:rgba(0,255,255,0.1); color:#00ffff; border:1.5px solid rgba(0,255,255,0.5); padding:11px; border-radius:30px; font-family:'Courier New',monospace; font-size:12px; font-weight:bold; letter-spacing:2px; cursor:pointer; width:100%; }

/* ‚îÄ‚îÄ Leaderboard modal ‚îÄ‚îÄ */
#lb-modal { display:none; position:fixed; inset:0; background:rgba(3,3,18,0.99); z-index:200; flex-direction:column; align-items:center; }
#lb-modal.show { display:flex; }
#lb-canvas { width:100%; flex:1; display:block; }
#btn-lb-close { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,255,255,0.1); color:#00ffff; border:1.5px solid rgba(0,255,255,0.5); padding:11px 32px; border-radius:30px; font-family:'Courier New',monospace; font-size:12px; font-weight:bold; letter-spacing:2px; cursor:pointer; z-index:201; }
</style>
</head>
<body>
<canvas id="c"></canvas>

<div id="share-modal">
  <canvas id="share-canvas" width="520" height="310" style="display:none"></canvas>
  <img id="share-img" style="display:none;border-radius:14px;max-width:88vw;max-height:52vh;box-shadow:0 0 40px #00ffff44;object-fit:contain;" alt="">
  <div id="video-wrap">
    <video id="share-video" autoplay loop muted playsinline></video>
  </div>
  <div id="share-rec" style="display:none;color:rgba(0,255,255,0.6);font-size:12px;letter-spacing:3px;padding:24px 0">‚è∫ CAPTURING VIDEO...</div>
  <div class="srow">
    <button class="sbtn" id="btn-sn"><span>SHARE</span></button>
    <button class="sbtn" id="btn-copy">COPY LINK</button>
    <button class="sbtn" id="btn-cl">CLOSE</button>
  </div>
</div>

<div id="auth-modal">
  <div class="auth-title">JOIN THE BOARD</div>
  <div class="auth-tabs">
    <button class="auth-tab active" id="tab-login">LOG IN</button>
    <button class="auth-tab" id="tab-signup">SIGN UP</button>
  </div>
  <div class="auth-form" id="form-login">
    <input class="auth-inp" id="inp-email" type="email" placeholder="EMAIL" autocomplete="email">
    <input class="auth-inp" id="inp-pass" type="password" placeholder="PASSWORD" autocomplete="current-password">
    <button class="auth-btn" id="btn-do-login">LOG IN</button>
    <button class="auth-link" id="btn-forgot">Forgot password?</button>
  </div>
  <div class="auth-form" id="form-signup" style="display:none">
    <input class="auth-inp" id="inp-su-name" type="text" placeholder="USERNAME (shown on leaderboard)" maxlength="18" autocomplete="off">
    <input class="auth-inp" id="inp-su-email" type="email" placeholder="EMAIL" autocomplete="email">
    <input class="auth-inp" id="inp-su-pass" type="password" placeholder="PASSWORD (min 6 chars)" autocomplete="new-password">
    <button class="auth-btn" id="btn-do-signup">CREATE ACCOUNT</button>
  </div>
  <div class="auth-msg" id="auth-msg"></div>
  <button class="sbtn" id="btn-auth-close">Maybe Later</button>
</div>

<div id="settings-modal">
  <div class="settings-box">
    <div class="settings-title">‚öô SETTINGS</div>
    <div class="settings-row">
      <div class="settings-lbl">MUSIC VOLUME <span id="lbl-music">60%</span></div>
      <input type="range" id="sl-music" min="0" max="1" step="0.01" value="0.6">
    </div>
    <div class="settings-row">
      <div class="settings-lbl">SFX VOLUME <span id="lbl-sfx">80%</span></div>
      <input type="range" id="sl-sfx" min="0" max="1" step="0.01" value="0.8">
    </div>
    <div class="settings-section" id="settings-user-section">
      <div class="settings-user" id="settings-user-info"></div>
      <div id="settings-username-row" style="display:none;flex-direction:column;gap:6px;">
        <input class="auth-inp" id="inp-change-username" type="text" placeholder="NEW USERNAME" maxlength="18" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        <button class="auth-btn" id="btn-change-username">CHANGE USERNAME</button>
        <div id="username-change-msg" style="font-size:10px;text-align:center;min-height:14px;letter-spacing:0.5px"></div>
      </div>
      <button id="btn-signout">SIGN OUT</button>
    </div>
    <button id="btn-settings-close">CLOSE</button>
  </div>
</div>

<div id="lb-modal">
  <canvas id="lb-canvas"></canvas>
  <button id="btn-lb-close">CLOSE</button>
</div>

<div id="how-modal">
  <div id="how-box">
    <h2>HOW TO PLAY</h2>
    <div id="how-rows">
    <div class="how-row"><span class="how-icon">üîµ</span><div class="how-text"><b>BLUE BALL</b> is fixed at center ‚Äî your life. Enemies or blast touching it = game over.</div></div>
    <div class="how-row"><span class="how-icon">üü°</span><div class="how-text"><b>DRAG</b> the yellow ball to swing the chain around. Keep moving ‚Äî don't sit still!</div></div>
    <div class="how-row"><span class="how-icon">‚õì</span><div class="how-text"><b>CHAIN</b> enemies by hitting them with the yellow ball. They orbit behind you (max 5). Chain 2+ to activate your multiplier!</div></div>
    <div class="how-row"><span class="how-icon">üí•</span><div class="how-text"><b>FAST SWIPE</b> to fling all chained enemies as projectiles. They fly and destroy free enemies. Each successful fling adds <b>+1</b> to your streak ‚Äî miss and it resets to zero!</div></div>
    <div class="how-row"><span class="how-icon">‚úñÔ∏è</span><div class="how-text"><b>MULTIPLIER</b> (bottom-right) = chain size + fling streak. Score on every kill shows as <b>pts √ó mult</b>. Never miss a fling to keep it growing!</div></div>
    <div class="how-row"><span class="how-icon">üå°Ô∏è</span><div class="how-text"><b>HEAT</b> builds while carrying enemies and spinning fast. Go red and your chain <b>SNAPS</b> ‚Äî you lose all chained enemies. Let it cool by slowing down.</div></div>
    <div class="how-row"><span class="how-icon">üí£</span><div class="how-text"><b>BOMBS</b> (orange octagon) have a 2.5s fuse ring. Fling them before it closes! Free bombs explode with a blast radius ‚Äî touching either ball = game over.</div></div>
    <div class="how-row"><span class="how-icon">‚ö†Ô∏è</span><div class="how-text">Later waves add <b>Dodgers</b> (evade your ball), <b>Tanks</b> (move in bursts, accelerate over time), and <b>Splitters</b> (split on death). Stay unpredictable!</div></div>
    </div>
    <button id="btn-how-close">LET'S GO!</button>
  </div>
</div>

<div id="user-badge"><span id="user-name"></span></div>
<button id="btn-login">‚ö° LOGIN</button>
<button id="btn-pause">PAUSE</button>

<!-- Firebase v9 compat -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAIN PANIC v4
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/*
  FIREBASE SETUP:
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  1. Go to https://console.firebase.google.com
  2. Create a new project (uses your Google account)
  3. Add a Web App ‚Äî copy the config below
  4. Authentication ‚Üí Sign-in method ‚Üí Google ‚Üí Enable
  5. Firestore Database ‚Üí Create database (start in test mode)
  6. Firestore ‚Üí Rules ‚Üí paste these rules:

     rules_version = '2';
     service cloud.firestore {
       match /databases/{database}/documents {
         match /scores/{userId} {
           allow read: if true;
           allow write: if request.auth != null
             && request.auth.uid == userId
             && request.auth.token.email_verified == true
             && request.resource.data.score is number
             && request.resource.data.score >= 0
             && request.resource.data.score < 1000000
             && request.resource.data.userId == request.auth.uid;
         }
         match /users/{userId} {
           allow read: if request.auth != null
             && request.auth.uid == userId;
           allow write: if request.auth != null
             && request.auth.uid == userId;
         }
       }
     }

  7. Firestore ‚Üí Indexes ‚Üí Composite ‚Üí Add:
     Collection: scores | Fields: dayKey ASC, score DESC
     Collection: scores | Fields: weekKey ASC, score DESC

  NETLIFY DEPLOY:
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  1. https://app.netlify.com/drop ‚Üí drag this file
  2. Site Settings ‚Üí General ‚Üí rename to "chain-panic"
  3. URL: https://chain-panic.netlify.app
  4. Update GAME_URL below and redeploy
*/

// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GAME_URL = 'https://chain-panic.pages.dev';

const FIREBASE_CONFIG = {
  apiKey:            'AIzaSyCSyIDlZ67RDwlbv3qarLeFom3fCnb7F1A',
  authDomain:        'chain-panic.firebaseapp.com',
  projectId:         'chain-panic',
  storageBucket:     'chain-panic.firebasestorage.app',
  messagingSenderId: '432465030755',
  appId:             '1:432465030755:web:f97bfd49db3713c3705256'
};
const FB_READY = FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY';

// ‚îÄ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let fbAuth = null, fbDb = null, currentUser = null;
let currentUsername = localStorage.getItem('cp_username') || '';
if (FB_READY) {
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    fbAuth = firebase.auth();
    fbDb   = firebase.firestore();
  } catch(e) { console.warn('Firebase init failed', e); }
}

// ‚îÄ‚îÄ‚îÄ PROFANITY FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BAD_WORDS = ['fuck','shit','cunt','ass','bitch','dick','cock','pussy','nigger','nigga','faggot','fag','retard','whore','slut','bastard','twat','prick','wanker','arsehole','asshole','bollocks','crap','damn','piss','tit','anus'];
function containsProfanity(str) {
  const s = str.toLowerCase().replace(/[^a-z0-9]/g,'');
  return BAD_WORDS.some(w => s.includes(w));
}
function validateUsername(name) {
  if (!name || name.trim().length < 2) return 'Username must be at least 2 characters';
  if (name.trim().length > 18) return 'Username must be 18 characters or less';
  if (!/^[a-zA-Z0-9_\-. ]+$/.test(name)) return 'Letters, numbers, spaces, _ - . only';
  if (containsProfanity(name)) return 'That username isn\'t allowed';
  return null;
}

// ‚îÄ‚îÄ‚îÄ VOLUME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let musicVol = parseFloat(localStorage.getItem('cp_music') ?? 0.6);
let sfxVol   = parseFloat(localStorage.getItem('cp_sfx')   ?? 0.8);

function getWeekKey(d) {
  const jan1 = new Date(d.getFullYear(), 0, 1);
  const wk = Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${String(wk).padStart(2,'0')}`;
}

function setAuthMsg(msg, isErr, html=false) {
  const el = document.getElementById('auth-msg');
  if (html) el.innerHTML = msg; else el.textContent = msg;
  el.className = 'auth-msg ' + (isErr ? 'err' : 'ok');
}
async function doResendVerification() {
  try {
    if (fbAuth && fbAuth.currentUser) {
      await fbAuth.currentUser.sendEmailVerification();
      setAuthMsg('Verification email resent ‚Äî check your spam folder too.', false);
    }
  } catch(e) { setAuthMsg('Could not resend ‚Äî try again in a minute.', true); }
}

async function initAuth() {
  if (!fbAuth) { if (FB_READY) document.getElementById('btn-login').classList.add('show'); return; }
  fbAuth.onAuthStateChanged(async user => {
    currentUser = user;
    const badge = document.getElementById('user-badge');
    const loginBtn = document.getElementById('btn-login');
    if (user) {
      // Load username from Firestore
      if (fbDb) {
        try {
          const doc = await fbDb.collection('users').doc(user.uid).get();
          if (doc.exists) { currentUsername = doc.data().username || ''; localStorage.setItem('cp_username', currentUsername); }
        } catch(e) {}
      }
      if (!user.emailVerified) {
        // Unverified: keep login button so user can always reopen the modal
        loginBtn.classList.add('show');
        badge.classList.remove('show');
        setAuthMsg('Email not verified ‚Äî check your spam folder, or <span style="color:#00ffff;text-decoration:underline;cursor:pointer" onclick="doResendVerification()">tap here to resend</span>.', true, true);
      } else {
        badge.classList.add('show'); loginBtn.classList.remove('show');
        document.getElementById('user-name').textContent = (currentUsername || user.email.split('@')[0]).toUpperCase();
        document.getElementById('auth-modal').classList.remove('show');
        resumeFromModal();
      }
      updateSettingsUser();
    } else {
      currentUsername = '';
      badge.classList.remove('show');
      if (FB_READY) loginBtn.classList.add('show');
      updateSettingsUser();
    }
  });
}

function authError(code, fallback) {
  const map = {
    'auth/invalid-credential':        'Incorrect email or password.',
    'auth/invalid-login-credentials': 'Incorrect email or password.',
    'auth/wrong-password':            'Incorrect email or password.',
    'auth/user-not-found':            'No account found with that email.',
    'auth/invalid-email':             'Please enter a valid email address.',
    'auth/email-already-in-use':      'An account with that email already exists.',
    'auth/weak-password':             'Password must be at least 6 characters.',
    'auth/too-many-requests':         'Too many attempts ‚Äî please wait a moment and try again.',
    'auth/user-disabled':             'This account has been disabled.',
    'auth/network-request-failed':    'Network error ‚Äî check your connection and try again.',
    'auth/missing-password':          'Please enter your password.',
    'auth/missing-email':             'Please enter your email address.',
    'auth/operation-not-allowed':     'Sign-in is not available right now.',
  };
  return map[code] || fallback;
}

async function doLogin() {
  const email = document.getElementById('inp-email').value.trim();
  const pass  = document.getElementById('inp-pass').value;
  if (!email || !pass) { setAuthMsg('Please fill in all fields.', true); return; }
  try {
    setAuthMsg('Logging in‚Ä¶', false);
    await fbAuth.signInWithEmailAndPassword(email, pass);
    // Don't clear message here ‚Äî onAuthStateChanged handles all post-login UI:
    // verified ‚Üí closes modal; unverified ‚Üí shows resend prompt.
  } catch(e) {
    setAuthMsg(authError(e.code, 'Login failed ‚Äî please try again.'), true);
  }
}

async function doSignup() {
  const name  = document.getElementById('inp-su-name').value.trim();
  const email = document.getElementById('inp-su-email').value.trim();
  const pass  = document.getElementById('inp-su-pass').value;
  const nameErr = validateUsername(name);
  if (nameErr) { setAuthMsg(nameErr, true); return; }
  if (!email) { setAuthMsg('Please enter your email.', true); return; }
  if (pass.length < 6) { setAuthMsg('Password must be at least 6 characters.', true); return; }
  try {
    setAuthMsg('Creating account‚Ä¶', false);
    const cred = await fbAuth.createUserWithEmailAndPassword(email, pass);
    if (fbDb) await fbDb.collection('users').doc(cred.user.uid).set({ username: name, email });
    currentUsername = name; localStorage.setItem('cp_username', name);
    await cred.user.sendEmailVerification();
    setAuthMsg('Account created! Check your email to verify ‚Äî check spam if it doesn\'t arrive.', false);
  } catch(e) {
    setAuthMsg(authError(e.code, 'Sign up failed ‚Äî please try again.'), true);
  }
}

async function doForgotPassword() {
  const email = document.getElementById('inp-email').value.trim();
  if (!email) { setAuthMsg('Enter your email above first.', true); return; }
  try {
    await fbAuth.sendPasswordResetEmail(email);
    setAuthMsg('Reset email sent ‚Äî check your inbox and spam folder.', false);
  } catch(e) {
    setAuthMsg(authError(e.code, 'Could not send reset email ‚Äî please try again.'), true);
  }
}

async function logout() {
  if (!fbAuth) return;
  await fbAuth.signOut();
  currentUsername = ''; localStorage.removeItem('cp_username');
}

// Auth modal tab switching
document.getElementById('tab-login').addEventListener('click', () => {
  document.getElementById('form-login').style.display = '';
  document.getElementById('form-signup').style.display = 'none';
  document.getElementById('tab-login').classList.add('active');
  document.getElementById('tab-signup').classList.remove('active');
  setAuthMsg('', false);
});
document.getElementById('tab-signup').addEventListener('click', () => {
  document.getElementById('form-signup').style.display = '';
  document.getElementById('form-login').style.display = 'none';
  document.getElementById('tab-signup').classList.add('active');
  document.getElementById('tab-login').classList.remove('active');
  setAuthMsg('', false);
});
document.getElementById('btn-do-login').addEventListener('click', doLogin);
document.getElementById('btn-do-signup').addEventListener('click', doSignup);
document.getElementById('btn-forgot').addEventListener('click', doForgotPassword);
document.getElementById('btn-auth-close').addEventListener('click', () => {
  document.getElementById('auth-modal').classList.remove('show');
  resumeFromModal();
});
document.getElementById('user-badge').addEventListener('click', () => openSettings());
document.getElementById('btn-login').addEventListener('click', () => {
  pauseForModal();
  document.getElementById('auth-modal').classList.add('show');
});
document.getElementById('btn-how-close').addEventListener('click', () => document.getElementById('how-modal').classList.remove('show'));

// ‚îÄ‚îÄ‚îÄ SETTINGS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSettingsUser() {
  const sec = document.getElementById('settings-user-section');
  const info = document.getElementById('settings-user-info');
  const unRow = document.getElementById('settings-username-row');
  if (currentUser) {
    sec.style.display = '';
    info.innerHTML = `Signed in as <b>${currentUsername || currentUser.email}</b>${currentUser.emailVerified ? '' : ' <span style="color:#ffaa00">(unverified)</span>'}`;
    unRow.style.display = 'flex';
  } else {
    sec.style.display = 'none';
  }
}
async function doChangeUsername() {
  const input = document.getElementById('inp-change-username');
  const msgEl = document.getElementById('username-change-msg');
  const name = input.value.trim();
  msgEl.textContent = '';
  const err = validateUsername(name);
  if (err) { msgEl.style.color='#ff5555'; msgEl.textContent=err; return; }
  if (name.toLowerCase() === (currentUsername||'').toLowerCase()) {
    msgEl.style.color='#ffaa00'; msgEl.textContent="That's already your username"; return;
  }
  try {
    const db = firebase.firestore();
    const uid = currentUser.uid;
    await db.collection('users').doc(uid).set({ username: name }, { merge: true });
    const scoreRef = db.collection('scores').doc(uid);
    const scoreDoc = await scoreRef.get();
    if (scoreDoc.exists) await scoreRef.update({ username: name });
    currentUsername = name;
    localStorage.setItem('cp_username', name);
    document.getElementById('user-name').textContent = name.toUpperCase();
    input.value = '';
    updateSettingsUser();
    msgEl.style.color = '#00ff88'; msgEl.textContent = 'Username updated!';
    setTimeout(() => { msgEl.textContent = ''; }, 2500);
  } catch(e) {
    msgEl.style.color = '#ff5555'; msgEl.textContent = 'Failed to update ‚Äî please try again';
  }
}
document.getElementById('btn-change-username').addEventListener('click', doChangeUsername);
document.getElementById('inp-change-username').addEventListener('keydown', e => { if(e.key==='Enter') doChangeUsername(); });

// ‚îÄ‚îÄ‚îÄ MODAL PAUSE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pausedForModal = false;
function pauseForModal() {
  if (state === ST.PLAY) {
    state = ST.PAUSE; stopBgMusic();
    document.getElementById('btn-pause').textContent = 'RESUME';
    pausedForModal = true;
  }
}
function resumeFromModal() {
  if (pausedForModal) {
    pausedForModal = false;
    if (state === ST.PAUSE) {
      state = ST.PLAY; lastTime = performance.now(); startBgMusic();
      document.getElementById('btn-pause').textContent = 'PAUSE';
    }
  }
}

function openSettings() {
  pauseForModal();
  const sm = document.getElementById('sl-music');
  const ss = document.getElementById('sl-sfx');
  sm.value = musicVol; document.getElementById('lbl-music').textContent = Math.round(musicVol*100)+'%';
  ss.value = sfxVol;   document.getElementById('lbl-sfx').textContent   = Math.round(sfxVol*100)+'%';
  updateSettingsUser();
  document.getElementById('settings-modal').classList.add('show');
}
document.getElementById('sl-music').addEventListener('input', e => {
  musicVol = parseFloat(e.target.value);
  if (musicGain) musicGain.gain.value = musicVol;
  localStorage.setItem('cp_music', musicVol);
  document.getElementById('lbl-music').textContent = Math.round(musicVol*100)+'%';
});
document.getElementById('sl-sfx').addEventListener('input', e => {
  sfxVol = parseFloat(e.target.value);
  localStorage.setItem('cp_sfx', sfxVol);
  document.getElementById('lbl-sfx').textContent = Math.round(sfxVol*100)+'%';
});
document.getElementById('btn-signout').addEventListener('click', () => {
  logout();
  document.getElementById('settings-modal').classList.remove('show');
  resumeFromModal();
});
document.getElementById('btn-settings-close').addEventListener('click', () => {
  document.getElementById('settings-modal').classList.remove('show');
  resumeFromModal();
});

// ‚îÄ‚îÄ‚îÄ LEADERBOARD MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lbModalData = null, lbModalTab = 'daily', lbModalLoading = false;
let lbRaf = null;

function openLeaderboard() {
  if (!currentUser) { pauseForModal(); document.getElementById('auth-modal').classList.add('show'); return; }
  pauseForModal();
  const modal = document.getElementById('lb-modal');
  const cv = document.getElementById('lb-canvas');
  modal.classList.add('show');
  cv.width = window.innerWidth * (window.devicePixelRatio||1);
  cv.height = (window.innerHeight - 60) * (window.devicePixelRatio||1);
  cv.style.width = window.innerWidth + 'px';
  cv.style.height = (window.innerHeight - 60) + 'px';
  lbModalTab = 'daily'; lbModalData = null; lbModalLoading = true;
  fetchLeaderboard().then(d => { lbModalData = d; lbModalLoading = false; renderLbModal(); });
  renderLbModal();
}
function renderLbModal() {
  const cv = document.getElementById('lb-canvas');
  if (!cv || !document.getElementById('lb-modal').classList.contains('show')) return;
  const cx = cv.getContext('2d');
  const dpr = window.devicePixelRatio||1;
  const W2 = cv.width/dpr, H2 = cv.height/dpr;
  cx.save(); cx.scale(dpr,dpr);
  cx.fillStyle='#07070e'; cx.fillRect(0,0,W2,H2);
  cx.font=`bold 14px 'Courier New'`; cx.textAlign='center'; cx.fillStyle='#ffd700'; cx.shadowBlur=12; cx.shadowColor='#ffd700';
  cx.fillText('üèÜ  LEADERBOARD', W2/2, 32);
  const tabs=['daily','weekly','allTime'], labels=['TODAY','WEEK','ALL TIME'];
  const tw=Math.min(320,W2-40)/3, tx0=(W2-tw*3)/2;
  tabs.forEach((tab,i)=>{
    const x=tx0+i*tw, active=tab===lbModalTab;
    cx.fillStyle=active?'rgba(0,255,255,0.14)':'rgba(255,255,255,0.03)'; cx.fillRect(x,44,tw,24);
    cx.strokeStyle=active?'rgba(0,255,255,0.5)':'rgba(255,255,255,0.08)'; cx.lineWidth=1; cx.strokeRect(x,44,tw,24);
    cx.font=`${active?'bold ':''}10px 'Courier New'`; cx.fillStyle=active?'#00ffff':'rgba(255,255,255,0.35)';
    cx.shadowBlur=active?5:0; cx.shadowColor='#00ffff'; cx.fillText(labels[i], x+tw/2, 60);
  });
  if (lbModalLoading) {
    cx.font=`12px 'Courier New'`; cx.textAlign='center'; cx.fillStyle='rgba(0,255,255,0.4)'; cx.shadowBlur=0;
    cx.fillText('LOADING...', W2/2, H2/2); cx.restore(); return;
  }
  const list = lbModalData ? lbModalData[lbModalTab] : [];
  if (!list.length) {
    cx.font=`12px 'Courier New'`; cx.textAlign='center'; cx.fillStyle='rgba(255,255,255,0.3)'; cx.shadowBlur=0;
    cx.fillText('NO SCORES YET', W2/2, H2/2); cx.restore(); return;
  }
  const rowH=52, rowTop=80, rowW=Math.min(380,W2-32), rowX=(W2-rowW)/2;
  const maxRows=Math.floor((H2-rowTop)/rowH);
  list.slice(0,maxRows).forEach((en,i)=>{
    const y=rowTop+i*rowH, isMe=currentUser&&en.userId===currentUser.uid;
    cx.fillStyle=isMe?'rgba(255,215,0,0.1)':i<3?['rgba(255,215,0,0.05)','rgba(200,200,200,0.03)','rgba(180,100,30,0.03)'][i]:'transparent';
    cx.fillRect(rowX,y,rowW,rowH-2);
    const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':null;
    cx.font=`bold 13px 'Courier New'`; cx.textAlign='left'; cx.fillStyle=isMe?'#ffd700':'#fff'; cx.shadowBlur=isMe?8:0; cx.shadowColor='#ffd700';
    cx.fillText(`${medal||('#'+(i+1)+'  ')}${en.username||'Player'}`, rowX+8, y+20);
    cx.font=`11px 'Courier New'`; cx.fillStyle='rgba(255,255,255,0.4)'; cx.shadowBlur=0;
    cx.fillText(`${en.flingCount} flung ¬∑ streak x${en.maxCombo}`, rowX+8, y+38);
    cx.font=`bold 18px 'Courier New'`; cx.textAlign='right'; cx.fillStyle=isMe?'#ffd700':'#00ffff'; cx.shadowBlur=isMe?8:4; cx.shadowColor=isMe?'#ffd700':'#00ffff';
    cx.fillText(en.score, rowX+rowW-8, y+24);
  });
  cx.restore();
}
document.getElementById('lb-canvas').addEventListener('click', e => {
  const cv = document.getElementById('lb-canvas');
  const dpr = window.devicePixelRatio||1;
  const W2 = cv.width/dpr;
  const tabs=['daily','weekly','allTime'];
  const tw=Math.min(320,W2-40)/3, tx0=(W2-tw*3)/2;
  const rect = cv.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  if (my>=44&&my<=68) {
    tabs.forEach((tab,i)=>{ if(mx>=tx0+i*tw&&mx<=tx0+(i+1)*tw){ lbModalTab=tab; renderLbModal(); }});
  }
});
document.getElementById('btn-lb-close').addEventListener('click', () => {
  document.getElementById('lb-modal').classList.remove('show');
  resumeFromModal();
});

async function submitScore(sc, fc, mc) {
  if (!fbDb || !currentUser || !currentUser.emailVerified) return;
  try {
    const now = new Date();
    const ref = fbDb.collection('scores').doc(currentUser.uid);
    const doc = await ref.get();
    if (!doc.exists || doc.data().score < sc) {
      await ref.set({
        userId:   currentUser.uid,
        username: currentUsername || currentUser.email.split('@')[0],
        score: sc, flingCount: fc, maxCombo: mc,
        dayKey:  now.toISOString().split('T')[0],
        weekKey: getWeekKey(now),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  } catch(e) { console.warn('Score submit failed', e); }
}

async function fetchLeaderboard() {
  if (!fbDb) return { daily:[], weekly:[], allTime:[] };
  const now = new Date();
  const today = now.toISOString().split('T')[0];
  const week  = getWeekKey(now);
  try {
    const [d,w,a] = await Promise.all([
      fbDb.collection('scores').where('dayKey','==',today).orderBy('score','desc').limit(50).get(),
      fbDb.collection('scores').where('weekKey','==',week).orderBy('score','desc').limit(50).get(),
      fbDb.collection('scores').orderBy('score','desc').limit(50).get()
    ]);
    return {
      daily:   d.docs.map(x=>x.data()),
      weekly:  w.docs.map(x=>x.data()),
      allTime: a.docs.map(x=>x.data())
    };
  } catch(e) { console.warn('Leaderboard fetch failed', e); return {daily:[],weekly:[],allTime:[]}; }
}

function findPlayerRank(list) {
  if (!currentUser) return -1;
  return list.findIndex(s => s.userId === currentUser.uid);
}

// ‚îÄ‚îÄ‚îÄ CANVAS / RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('c');
const ctx    = canvas.getContext('2d');
let W, H, DPR;
function resize() {
  DPR = window.devicePixelRatio || 1;
  W = window.innerWidth; H = window.innerHeight;
  canvas.width = W*DPR; canvas.height = H*DPR;
  canvas.style.width = W+'px'; canvas.style.height = H+'px';
  ctx.scale(DPR, DPR);
}
resize(); window.addEventListener('resize', resize);

// ‚îÄ‚îÄ‚îÄ AUDIO (with recording destination) ‚îÄ‚îÄ
let AC = null, audioDestNode = null, musicGain = null;

function initAudio() {
  if (!AC) {
    AC = new (window.AudioContext || window.webkitAudioContext)();
    audioDestNode = AC.createMediaStreamDestination();
    musicGain = AC.createGain();
    musicGain.gain.value = musicVol;
    musicGain.connect(AC.destination);
  }
  if (AC.state === 'suspended') AC.resume().catch(()=>{});
}

function beep(freq, type, dur, vol, freqEnd) {
  if (!AC) return;
  const play = () => {
    try {
      const o=AC.createOscillator(), g=AC.createGain(), t=AC.currentTime;
      o.connect(g); g.connect(AC.destination);
      if (audioDestNode) g.connect(audioDestNode);
      o.type = type||'sine'; o.frequency.setValueAtTime(freq, t);
      if (freqEnd) o.frequency.exponentialRampToValueAtTime(Math.max(0.01,freqEnd), t+dur);
      const v = (vol||0.2) * sfxVol;
      g.gain.setValueAtTime(v, t); g.gain.exponentialRampToValueAtTime(0.001, t+dur);
      o.start(t); o.stop(t+dur);
    } catch(e) {}
  };
  if (AC.state === 'running') { play(); }
  else { AC.resume().then(play).catch(()=>{}); }
}

// Resume audio when tab becomes active again
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && AC && AC.state !== 'running') AC.resume().catch(()=>{});
});
window.addEventListener('focus', () => {
  if (AC && AC.state !== 'running') AC.resume().catch(()=>{});
});

// ‚îÄ‚îÄ‚îÄ BACKGROUND MUSIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 8-step sequencer (8th notes at 128bpm ‚âà 234ms each)
// Uses Web Audio lookahead scheduling so timing never drifts
let bgMusicTimer=null, musicBeat=0, nextBeatTime=0;
const MUSIC_STEP=60/(128*2); // seconds per 8th note (~0.234s)
const MUSIC_LOOKAHEAD=0.15;  // schedule this far ahead (seconds)
const MUSIC_INTERVAL=50;     // scheduler poll interval (ms)

// Patterns: 1=hit, 0=rest
const MK=[1,0,0,0,1,0,0,0]; // kick   ‚Äî beat 1 & 3
const MS=[0,0,1,0,0,0,1,0]; // snare  ‚Äî beat 2 & 4
const MH=[1,1,1,1,1,1,1,1]; // hi-hat ‚Äî every 8th note
// Bass melody in Hz (0=rest)  ‚Äî A minor pentatonic
const MB=[55,0,55,0,73,0,65,55];

function musicTick(t){
  // t = precise Web Audio timestamp to schedule this beat at
  const s=musicBeat%8;
  const md=musicGain||AC.destination;
  if(MK[s]){const o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(md);if(audioDestNode)g.connect(audioDestNode);o.type='sine';o.frequency.setValueAtTime(190,t);o.frequency.exponentialRampToValueAtTime(38,t+0.18);g.gain.setValueAtTime(0.45,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.22);o.start(t);o.stop(t+0.22);}
  if(MS[s]){const o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(md);if(audioDestNode)g.connect(audioDestNode);o.type='sawtooth';o.frequency.value=200;g.gain.setValueAtTime(0.13,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.11);o.start(t);o.stop(t+0.11);}
  if(MB[s]){const o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(md);if(audioDestNode)g.connect(audioDestNode);o.type='sine';o.frequency.value=MB[s];g.gain.setValueAtTime(0.28,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.32);o.start(t);o.stop(t+0.32);}
  if(MH[s]){const v=s%2===0?0.07:0.04,d=s%2===0?0.05:0.03;const o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(md);if(audioDestNode)g.connect(audioDestNode);o.type='square';o.frequency.value=7200+s*200;g.gain.setValueAtTime(v,t);g.gain.exponentialRampToValueAtTime(0.001,t+d);o.start(t);o.stop(t+d);}
  musicBeat++;
}
function musicScheduler(){
  if(!AC||state!==ST.PLAY)return;
  if(AC.state!=='running'){AC.resume().catch(()=>{});return;}
  while(nextBeatTime<AC.currentTime+MUSIC_LOOKAHEAD){
    musicTick(nextBeatTime);
    nextBeatTime+=MUSIC_STEP;
  }
}
function startBgMusic(){
  if(bgMusicTimer)return;
  musicBeat=0;
  nextBeatTime=AC?AC.currentTime+0.05:0;
  bgMusicTimer=setInterval(musicScheduler,MUSIC_INTERVAL);
  musicScheduler();
}
function stopBgMusic(){if(bgMusicTimer){clearInterval(bgMusicTimer);bgMusicTimer=null;}musicBeat=0;}

function snd(n) {
  switch(n) {
    case 'hit':     beep(180,'sawtooth',0.18,0.3,70); break;
    case 'chain':   beep(440,'square',0.1,0.15,880); break;
    case 'fling':   beep(300,'sawtooth',0.25,0.4,60); beep(600,'sine',0.15,0.2,1200); break;
    case 'bomb':    beep(80,'sawtooth',0.5,0.5,30); beep(160,'square',0.3,0.3,40); break;
    case 'snap':    beep(200,'sawtooth',0.3,0.4,40); break;
    case 'death':   beep(300,'sawtooth',0.8,0.5,30); break;
    case 'combo':   beep(523,'sine',0.15,0.2); beep(659,'sine',0.15,0.15,800); break;
    case 'wave':    beep(400,'triangle',0.3,0.2,700); break;
    case 'victory': [0,.12,.24,.38,.54].forEach((d,i)=>setTimeout(()=>beep([523,659,784,1047,1318][i],'sine',0.35,0.2),d*1000)); break;
    case 'lb_tick': beep(600,'sine',0.05,0.08); break;
    case 'lb_land': beep(880,'sine',0.4,0.3,1760); beep(1100,'sine',0.4,0.15,2200); break;
  }
}

// ‚îÄ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MAX_PARTICLES = 400;
let P = [];
function spark(x,y,col,n=12,sp=5) {
  if (P.length > MAX_PARTICLES) P.splice(0, P.length - MAX_PARTICLES + n);
  for (let i=0;i<n;i++) {
    const a=Math.PI*2*i/n+(Math.random()-.5)*.8, s=sp*(0.4+Math.random()*.8);
    P.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:0.025+Math.random()*.03,r:2+Math.random()*3,col});
  }
}
function firework(x,y,cols) { spark(x,y,cols[Math.floor(Math.random()*cols.length)],24,8+Math.random()*5); }
function updateP(dt) { P=P.filter(p=>{p.x+=p.vx*dt*60;p.y+=p.vy*dt*60;p.vx*=0.94;p.vy=p.vy*0.94+0.06*dt*60;p.life-=p.decay*dt*60;return p.life>0;}); }
function drawP() { P.forEach(p=>{ctx.save();ctx.globalAlpha=p.life;ctx.shadowBlur=8;ctx.shadowColor=p.col;ctx.fillStyle=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);ctx.fill();ctx.restore();}); }

// ‚îÄ‚îÄ‚îÄ FLOATING TEXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let FT=[];
function txt(x,y,t,col='#fff',sz=20) { FT.push({x,y,t,col,sz,life:1,vy:-1.8}); }
function updateFT(dt) { FT=FT.filter(f=>{f.y+=f.vy*dt*60;f.life-=0.022*dt*60;return f.life>0;}); }
function drawFT() { FT.forEach(f=>{ctx.save();ctx.globalAlpha=f.life;ctx.font=`bold ${f.sz}px 'Courier New'`;ctx.textAlign='center';ctx.shadowBlur=12;ctx.shadowColor=f.col;ctx.fillStyle=f.col;ctx.fillText(f.t,f.x,f.y);ctx.restore();}); }

// ‚îÄ‚îÄ‚îÄ SHAKE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let SX=0,SY=0,SM=0;
function shake(m) { SM=Math.max(SM,m); }
function updateShake(dt) { if(SM>.1){SX=(Math.random()-.5)*SM;SY=(Math.random()-.5)*SM;SM*=Math.pow(.8,dt*60);}else{SX=SY=SM=0;} }
function easeInOutCubic(t) { return t<0.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2; }

// ‚îÄ‚îÄ‚îÄ CHAIN CLASS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Chain {
  constructor(px,py,segs=9,len=22) {
    this.nodes=[]; this.len=len;
    for(let i=0;i<segs;i++) this.nodes.push({x:px,y:py+i*len,ox:px,oy:py+i*len,pinned:i===0});
    this.ballR=14; this.svx=0; this.svy=0; this.chained=[];
    this.heat=0; this.lastTipAngle=null; this.rotAccum=0;
  }
  get tip() { return this.nodes[this.nodes.length-1]; }
  addEnemy(e) {
    e.chainAngle=Math.atan2(e.y-this.tip.y,e.x-this.tip.x); this.chained.push(e);
    const l=this.tip; this.nodes.push({x:l.x,y:l.y+this.len,ox:l.x,oy:l.y+this.len,pinned:false});
  }
  update(dt,px,py) {
    this.nodes[0].x=px; this.nodes[0].y=py;
    this.nodes.forEach(n=>{
      if(n.pinned)return;
      const vx=(n.x-n.ox)*.97,vy=(n.y-n.oy)*.97;
      n.ox=n.x;n.oy=n.y;n.x+=vx;n.y+=vy+dt*dt*550;
    });
    const tip=this.tip; tip.x+=this.svx*dt; tip.y+=this.svy*dt;
    this.svx*=Math.pow(.87,dt*60); this.svy*=Math.pow(.87,dt*60);
    for(let it=0;it<10;it++){
      for(let i=0;i<this.nodes.length-1;i++){
        const a=this.nodes[i],b=this.nodes[i+1];
        const dx=b.x-a.x,dy=b.y-a.y,d=Math.sqrt(dx*dx+dy*dy)||.001,diff=(d-this.len)/d*.5;
        if(!a.pinned){a.x+=dx*diff;a.y+=dy*diff;}
        if(!b.pinned){b.x-=dx*diff;b.y-=dy*diff;}
      }
    }
    const ang=Math.atan2(this.tip.y-py,this.tip.x-px);
    if(this.lastTipAngle!==null){let da=ang-this.lastTipAngle;if(da>Math.PI)da-=Math.PI*2;if(da<-Math.PI)da+=Math.PI*2;this.rotAccum+=Math.abs(da);}
    this.lastTipAngle=ang;
    this.heat+=dt*(this.chained.length/MAX_CHAIN*.18+(this.rotAccum/Math.PI)*.04);
    this.rotAccum=0; this.heat=Math.min(this.heat,1);
    this.chained.forEach((e,i)=>{
      const ax=this.tip.x,ay=this.tip.y;
      const tx=ax+Math.cos(e.chainAngle+i*.4)*this.len*(1.8+i*.3);
      const ty=ay+Math.sin(e.chainAngle+i*.4)*this.len*(1.8+i*.3);
      e.x+=(tx-e.x)*Math.min(dt*9,.95); e.y+=(ty-e.y)*Math.min(dt*9,.95); e.angle+=dt*4;
      if(e.bomb){e.fuseTimer-=dt;if(e.fuseTimer<=0){spark(e.x,e.y,'#ff6600',25,7);shake(15);snd('bomb');this.heat=Math.min(1,this.heat+.3);this.chained.splice(i,1);if(this.nodes.length>10)this.nodes.pop();}}
    });
  }
  fling(vx,vy) {
    const launched=this.chained.slice(); this.chained=[];
    while(this.nodes.length>10)this.nodes.pop();
    launched.forEach(e=>{e.projectile=true;e.chained=false;e.vx=vx*.8+(Math.random()-.5)*3;e.vy=vy*.8+(Math.random()-.5)*3;});
    this.svx+=vx*8; this.svy+=vy*8; this.heat=Math.max(0,this.heat-.4); snd('fling'); return launched;
  }
  snap() {
    spark(this.tip.x,this.tip.y,'#ff2200',20,6); this.chained=[];
    while(this.nodes.length>10)this.nodes.pop();
    this.heat=0; snd('snap'); shake(18); txt(W/2,H/2-50,'CHAIN SNAP!','#ff4400',30);
  }
  draw() {
    const n=this.nodes;
    for(let i=0;i<n.length-1;i++){
      const a=n[i],b=n[i+1];
      const r=Math.floor(100+this.heat*155),g=Math.floor(200-this.heat*130),bl=Math.floor(255-this.heat*200);
      ctx.save();ctx.strokeStyle=`rgb(${r},${g},${bl})`;ctx.lineWidth=3;ctx.shadowBlur=10;ctx.shadowColor=ctx.strokeStyle;
      ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();
      ctx.fillStyle='#fff';ctx.shadowBlur=4;ctx.shadowColor='#fff';ctx.beginPath();ctx.arc(b.x,b.y,2,0,Math.PI*2);ctx.fill();ctx.restore();
    }
    const tip=this.tip,hot=this.heat,bc=hot>.7?`hsl(${20+hot*10},100%,60%)`:'#ffdd44',gc=hot>.7?'#ff4400':'#ffaa00';
    ctx.save();
    const gr=ctx.createRadialGradient(tip.x,tip.y,0,tip.x,tip.y,this.ballR*2.5);
    gr.addColorStop(0,bc);gr.addColorStop(.5,gc);gr.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=gr;ctx.beginPath();ctx.arc(tip.x,tip.y,this.ballR*2.5,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=20+hot*20;ctx.shadowColor=gc;ctx.fillStyle=bc;ctx.beginPath();ctx.arc(tip.x,tip.y,this.ballR,0,Math.PI*2);ctx.fill();ctx.restore();
    this.chained.forEach(e=>e.draw(true));
  }
}

// ‚îÄ‚îÄ‚îÄ ENEMY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ETYPES=[
  {name:'chaser',  col:'#ff3355',glow:'#ff0033',sz:17,spd:65, pts:1,shape:'tri',hp:1},
  {name:'tank',    col:'#9944ff',glow:'#7700ee',sz:25,spd:62, pts:3,shape:'hex',hp:1,liner:true},
  {name:'speeder', col:'#33ffaa',glow:'#00ff88',sz:11,spd:120,pts:2,shape:'dia',hp:1},
  {name:'bomb',    col:'#ff7700',glow:'#ff6600',sz:19,spd:55, pts:4,shape:'bomb',hp:1,bomb:true},
  {name:'dodger',  col:'#ffff33',glow:'#ffcc00',sz:15,spd:70, pts:3,shape:'tri',hp:1,dodges:true},
  {name:'splitter',col:'#ff44aa',glow:'#ff0088',sz:18,spd:50, pts:2,shape:'dia',hp:1},
];
const MAX_CHAIN=5;

class Enemy {
  constructor(type,x,y){
    Object.assign(this,type); this.type=type; this.x=x; this.y=y;
    this.angle=Math.random()*Math.PI*2; this.chained=false; this.projectile=false;
    this.chainAngle=0; this.vx=0; this.vy=0;
    this.fuseTimer=type.bomb?2.5:999; this.dodgeTimer=Math.random()*2; this.dodgeDir=1;
    this.dashDir=this.liner?Math.atan2(H/2-y,W/2-x):Math.random()*Math.PI*2;
    this.dashTimer=this.liner?0.8+Math.random()*0.4:0;
    this.onScreen=false;
  }
  update(dt,px,py,bx,by){
    if(this.chained)return;
    if(this.projectile){
      this.x+=this.vx*dt*60;this.y+=this.vy*dt*60;this.vx*=.99;this.vy*=.99;
      if(!this.bomb)this.angle+=dt*18; // bombs don't spin as projectiles either
      const spd=Math.sqrt(this.vx*this.vx+this.vy*this.vy);
      if(spd<1.5&&spd>0.01){const s=1.5/spd;this.vx*=s;this.vy*=s;}
      this.projLife=(this.projLife||0)+dt; if(this.projLife>4)this.dead=true; return;
    }
    if(this.liner){
      if(!this.onScreen&&this.x>0&&this.x<W&&this.y>0&&this.y<H)this.onScreen=true;
      const cx=W/2,cy=H/2;
      const cdx=cx-this.x,cdy=cy-this.y;
      const distC=Math.sqrt(cdx*cdx+cdy*cdy);
      if(distC<this.sz*8){
        // Within 4 widths of centre ‚Äî lock on and hold line
        this.dashDir=Math.atan2(cdy,cdx);
        this.dashTimer=1.5;
      } else {
        this.dashTimer-=dt;
        if(this.dashTimer<=0){
          const toAngle=Math.atan2(py-this.y,px-this.x);
          const sign=Math.random()>.5?1:-1;
          this.dashDir=toAngle+sign*(Math.PI*(35/180)+Math.random()*Math.PI*(30/180));
          this.dashTimer=1.0+Math.random()*1.0;
          if(this.onScreen)this.spd=Math.min(this.spd*1.1,150);
        }
      }
      this.x+=Math.cos(this.dashDir)*this.spd*dt;
      this.y+=Math.sin(this.dashDir)*this.spd*dt;
      this.angle+=dt*2;
      return;
    }
    const dx=px-this.x,dy=py-this.y,d=Math.sqrt(dx*dx+dy*dy)||1;
    if(this.dodges){
      this.dodgeTimer-=dt; if(this.dodgeTimer<0){this.dodgeTimer=1+Math.random()*2;this.dodgeDir*=-1;}
      const bdx=bx-this.x,bdy=by-this.y,bd=Math.sqrt(bdx*bdx+bdy*bdy)||1;
      if(bd<120){this.x+=this.dodgeDir*(-bdy/bd)*this.spd*.7*dt;this.y+=this.dodgeDir*(bdx/bd)*this.spd*.7*dt;}
    }
    this.x+=(dx/d)*this.spd*dt; this.y+=(dy/d)*this.spd*dt;
    // Bombs do NOT rotate ‚Äî fixes visual artifact of triangle shadow under square
    if(!this.bomb) this.angle+=dt*2;
    if(this.bomb) this.fuseTimer-=dt;
  }
  draw(chained=false){
    if(this.projectile){
      ctx.save();ctx.globalAlpha=0.35;ctx.shadowBlur=20;ctx.shadowColor=this.glow;ctx.fillStyle=this.glow;
      ctx.beginPath();ctx.arc(this.x-this.vx*2,this.y-this.vy*2,this.sz*.9,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=0.12;ctx.beginPath();ctx.arc(this.x-this.vx*5,this.y-this.vy*5,this.sz*.6,0,Math.PI*2);ctx.fill();ctx.restore();
    }
    ctx.save();ctx.translate(this.x,this.y);
    // Bombs stay axis-aligned ‚Äî rotate only non-bombs
    ctx.rotate(this.bomb ? 0 : this.angle);
    ctx.globalAlpha=chained?.65:1;
    ctx.shadowBlur=this.projectile?30:chained?8:18;ctx.shadowColor=this.glow;
    ctx.fillStyle=this.col;ctx.strokeStyle='rgba(255,255,255,0.6)';ctx.lineWidth=1.5;
    const s=this.sz; ctx.beginPath();
    switch(this.shape){
      case 'tri':  ctx.moveTo(0,-s);ctx.lineTo(s*.87,s*.5);ctx.lineTo(-s*.87,s*.5); break;
      case 'hex':  for(let i=0;i<6;i++){const a=i/6*Math.PI*2-Math.PI/6;i?ctx.lineTo(Math.cos(a)*s,Math.sin(a)*s):ctx.moveTo(Math.cos(a)*s,Math.sin(a)*s);}break;
      case 'dia':  ctx.moveTo(0,-s*1.4);ctx.lineTo(s*.8,0);ctx.lineTo(0,s*1.4);ctx.lineTo(-s*.8,0); break;
      case 'sq':   ctx.rect(-s,-s,s*2,s*2); break;
      case 'bomb': for(let i=0;i<8;i++){const a=i/8*Math.PI*2-Math.PI/8;i?ctx.lineTo(Math.cos(a)*s,Math.sin(a)*s):ctx.moveTo(Math.cos(a)*s,Math.sin(a)*s);}break;
    }
    ctx.closePath();ctx.fill();ctx.stroke();

    if(this.bomb&&!chained){
      const ratio=Math.max(0,this.fuseTimer/2.5);
      // Clear shadow before drawing fuse ring to avoid bleed
      ctx.shadowBlur=0;
      ctx.strokeStyle=ratio>.4?'#ffcc00':'#ff2200';ctx.lineWidth=3;
      ctx.shadowBlur=6;ctx.shadowColor=ctx.strokeStyle;
      ctx.beginPath();ctx.arc(0,0,s+6,-Math.PI/2,-Math.PI/2+ratio*Math.PI*2);ctx.stroke();
    }
    ctx.restore();
  }
}

// ‚îÄ‚îÄ‚îÄ LIVE RECORDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Rolling recorder: restarts every 10s so each recording starts at T=0 ‚Äî no timestamp gaps.
// Canvas-only (no audio) to avoid music timing artifacts in the recorded video.
// Keeps previous complete 10s blob as fallback when death happens near a roll boundary.
// captureFinalVideo() immediately takes ownership so a quick retry can't corrupt data.
let videoBlob=null, videoURL=null;
let activeMediaStream=null, liveRecorder=null, liveChunks=[], liveRecMT='';
let rollTimer=null, prevBlob=null, recWindowStart=0;

function stopActiveStream(){
  if(rollTimer){clearInterval(rollTimer);rollTimer=null;}
  prevBlob=null;
  if(liveRecorder&&liveRecorder.state!=='inactive'){try{liveRecorder.stop();}catch(e){}}
  liveRecorder=null;liveChunks=[];
  if(activeMediaStream){activeMediaStream.getTracks().forEach(t=>t.stop());activeMediaStream=null;}
}

function _startRecorder(stream){
  liveChunks=[];
  recWindowStart=Date.now(); // track when this window began
  const myChunks=liveChunks; // each recorder closes over its OWN array ‚Äî no cross-contamination
  let mr;
  try{mr=new MediaRecorder(stream,liveRecMT?{mimeType:liveRecMT}:{});}catch(e){return;}
  mr.ondataavailable=e=>{if(e.data.size>0)myChunks.push(e.data);};
  mr.start(200);
  liveRecorder=mr;
}

function rollRecorder(stream){
  // Stop the current window and save it as prevBlob, then start a fresh recording
  const mr=liveRecorder;liveRecorder=null;
  const rolledChunks=liveChunks; // save before reassignment
  if(mr&&mr.state!=='inactive'){
    mr.onstop=()=>{if(rolledChunks.length)prevBlob=new Blob(rolledChunks,{type:liveRecMT||'video/mp4'});};
    try{mr.stop();}catch(e){}
  } else if(rolledChunks.length){
    prevBlob=new Blob(rolledChunks,{type:liveRecMT||'video/mp4'});
  }
  _startRecorder(stream);
}

function startLiveRecord(){
  stopActiveStream();
  if(!window.MediaRecorder||!canvas.captureStream)return;
  const cs=canvas.captureStream(30);activeMediaStream=cs;
  // iOS/WebKit (all iOS browsers use WebKit) has an unfixed bug: mixing canvas captureStream
  // with AudioContext audio in MediaRecorder fails to capture canvas frames ‚Äî produces a short
  // sped-up recording. Canvas-only is the only reliable option on iOS.
  const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.maxTouchPoints>1&&/Macintosh/.test(navigator.userAgent));
  let recStream=cs;
  if(!isIOS&&audioDestNode){try{recStream=new MediaStream([...cs.getTracks(),...audioDestNode.stream.getTracks()]);}catch(e){}}
  liveRecMT=['video/mp4;codecs=avc1','video/mp4','video/webm;codecs=vp9','video/webm;codecs=vp8','video/webm'].find(m=>MediaRecorder.isTypeSupported(m))||'';
  _startRecorder(recStream);
  rollTimer=setInterval(()=>rollRecorder(recStream),10000);
}

// Called immediately from die() ‚Äî takes ownership so a quick retry can't corrupt data.
function captureFinalVideo(stopDelay=2000,forceCurrentWindow=false){
  if(rollTimer){clearInterval(rollTimer);rollTimer=null;}
  if(videoURL){URL.revokeObjectURL(videoURL);videoURL=null;}videoBlob=null;
  const snapChunks=liveChunks;
  liveChunks=[];
  const windowAge=Date.now()-recWindowStart;
  const snapMT=liveRecMT;
  const snapPrev=prevBlob;prevBlob=null;
  const mr=liveRecorder;liveRecorder=null;
  let built=false;
  function buildBlob(){
    if(built)return;built=true;
    // Always prefer snapChunks ‚Äî it includes the death/victory screen captured during stopDelay.
    // Fall back to prevBlob only if the current window is completely empty (e.g. MediaRecorder
    // never started). The old windowAge guard was incorrectly dropping death-screen content.
    if(snapChunks.length>0){
      videoBlob=new Blob(snapChunks,{type:snapMT||'video/mp4'});
      videoURL=URL.createObjectURL(videoBlob);
    }else if(snapPrev){
      videoBlob=snapPrev;
      videoURL=URL.createObjectURL(videoBlob);
    }
  }
  if(mr&&mr.state!=='inactive'){
    mr.ondataavailable=e=>{if(e.data.size>0)snapChunks.push(e.data);};
    mr.onstop=buildBlob;
    setTimeout(()=>{try{mr.stop();}catch(e){buildBlob();}},stopDelay);
  }else{buildBlob();}
}

// ‚îÄ‚îÄ‚îÄ VICTORY / LEADERBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const VC=['#ffd700','#ff6b6b','#a855f7','#00ffff','#ff44aa','#00ff88'];
let victoryTimer=0,lbLoaded=false,lbScrollDone=false,lbScrollPos=0,lastLbTickIdx=0;
let lbData={daily:[],weekly:[],allTime:[]};
let lbTab='daily',lbRank={daily:-1,weekly:-1,allTime:-1};
const LB_ROW_H=52,LB_ROWS=7;



function drawVictory(dt){
  victoryTimer+=dt;
  const t=victoryTimer;
  drawBG();updateP(dt);updateShake(dt);

  // Fireworks burst
  if(t<7&&Math.random()<dt*7) firework(W*(0.2+Math.random()*0.6),H*(0.1+Math.random()*0.55),VC);

  // "NEW RECORD!" zoom in
  const textIn=Math.min(1,t/0.5),scl=0.35+easeInOutCubic(textIn)*0.65,fsV=Math.min(W*0.12,56);
  ctx.save();ctx.globalAlpha=textIn;ctx.translate(W/2,H*0.27);ctx.scale(scl,scl);
  ctx.font=`bold ${fsV}px 'Courier New'`;ctx.textAlign='center';
  ctx.shadowBlur=40;ctx.shadowColor='#ffd700';ctx.fillStyle='#ffd700';ctx.fillText('NEW',0,0);
  ctx.shadowColor='#fff';ctx.fillStyle='#fff';ctx.fillText('RECORD!',0,fsV*1.1);
  ctx.font=`bold ${fsV*0.58}px 'Courier New'`;ctx.fillStyle='#00ffff';ctx.shadowColor='#00ffff';ctx.shadowBlur=20;ctx.fillText(score,0,fsV*2.3);ctx.restore();

  // Expanding ring
  const rr=t*190;if(rr<H*1.5){ctx.save();ctx.globalAlpha=Math.max(0,0.4-t*0.06);ctx.strokeStyle='#ffd700';ctx.lineWidth=3;ctx.shadowBlur=16;ctx.shadowColor='#ffd700';ctx.beginPath();ctx.arc(W/2,H/2,rr,0,Math.PI*2);ctx.stroke();ctx.restore();}

  // Leaderboard panel slides up at t=3.5 ‚Äî covers most of screen
  if(t>3.5){
    const en=Math.min(1,(t-3.5)/0.8),pw=Math.min(400,W-40),ph=H*0.84,px=(W-pw)/2,panY=H-ph*easeInOutCubic(en);
    ctx.save();ctx.globalAlpha=easeInOutCubic(en);
    ctx.fillStyle='rgba(3,3,18,0.97)';ctx.shadowBlur=28;ctx.shadowColor='rgba(0,255,255,0.2)';
    if(ctx.roundRect)ctx.roundRect(px,panY,pw,ph,14);else ctx.rect(px,panY,pw,ph);ctx.fill();
    ctx.strokeStyle='rgba(0,255,255,0.4)';ctx.lineWidth=1.5;ctx.shadowBlur=10;ctx.shadowColor='#00ffff';
    if(ctx.roundRect)ctx.roundRect(px,panY,pw,ph,14);else ctx.rect(px,panY,pw,ph);ctx.stroke();ctx.restore();
    if(en>0.55) drawLbPanel(px,panY,pw,ph,t-3.5);
  }

  drawP();drawFT();

  // Share prompt + HOME after 10s
  if(t>10){
    const pulse=0.6+Math.sin(t*4)*0.4;
    ctx.save();ctx.globalAlpha=pulse;ctx.font=`bold 17px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='#00ffff';ctx.shadowBlur=22;ctx.shadowColor='#00ffff';ctx.fillText('[ SHARE YOUR ACHIEVEMENT ]',W/2,H-80);ctx.restore();
    // HOME button ‚Äî well above iOS bottom chrome
    const vHomeY=H-44;ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.06)';roundRect(ctx,W/2-70,vHomeY-20,140,36,10);ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.25)';ctx.lineWidth=1.5;roundRect(ctx,W/2-70,vHomeY-20,140,36,10);ctx.stroke();
    ctx.font=`bold 13px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='rgba(255,255,255,0.7)';ctx.shadowBlur=0;ctx.fillText('‚åÇ  HOME',W/2,vHomeY+4);ctx.restore();
  }


}

function drawLbPanel(px,py,pw,ph,elapsed){
  const list=lbData[lbTab]||[],rank=lbRank[lbTab];
  ctx.save();ctx.font=`bold 14px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='#ffd700';ctx.shadowBlur=12;ctx.shadowColor='#ffd700';ctx.fillText('üèÜ  LEADERBOARD',px+pw/2,py+24);ctx.restore();
  const tabs=['daily','weekly','allTime'],labels=['TODAY','WEEK','ALL TIME'],tw=pw/3;
  tabs.forEach((tab,i)=>{
    const tx=px+i*tw,ty=py+34,active=tab===lbTab;
    ctx.save();ctx.fillStyle=active?'rgba(0,255,255,0.14)':'rgba(255,255,255,0.03)';ctx.fillRect(tx,ty,tw,22);
    ctx.strokeStyle=active?'rgba(0,255,255,0.5)':'rgba(255,255,255,0.08)';ctx.lineWidth=1;ctx.strokeRect(tx,ty,tw,22);
    ctx.font=`${active?'bold ':''}10px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle=active?'#00ffff':'rgba(255,255,255,0.35)';ctx.shadowBlur=active?5:0;ctx.shadowColor='#00ffff';ctx.fillText(labels[i],tx+tw/2,ty+15);ctx.restore();
  });
  if(!lbLoaded){ctx.save();ctx.font=`12px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='rgba(0,255,255,0.4)';ctx.fillText('LOADING'+'.'.repeat(Math.floor(elapsed*2)%4),px+pw/2,py+ph/2);ctx.restore();return;}
  if(!list.length){ctx.save();ctx.font=`12px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='rgba(255,255,255,0.3)';ctx.fillText('BE FIRST ON THE BOARD!',px+pw/2,py+ph/2);ctx.restore();return;}
  // Scroll animation
  const scrollElapsed=Math.max(0,elapsed-0.5);
  if(rank>=0&&!lbScrollDone){
    const target=Math.max(0,rank-3),dur=Math.min(4.5,0.5+rank*0.18);
    if(scrollElapsed<dur){
      lbScrollPos=easeInOutCubic(scrollElapsed/dur)*target;
      const ni=Math.floor(lbScrollPos);if(ni>lastLbTickIdx){lastLbTickIdx=ni;snd('lb_tick');}
    }else{lbScrollPos=target;if(!lbScrollDone){lbScrollDone=true;snd('lb_land');spark(W/2,py+ph-LB_ROW_H,'#ffd700',28,6);}}
  }
  // Rows ‚Äî fill available height
  const rowTop=py+62,rowAreaH=ph-78;
  const visRows=Math.ceil(rowAreaH/LB_ROW_H);
  ctx.save();ctx.beginPath();ctx.rect(px+4,rowTop,pw-8,rowAreaH);ctx.clip();
  const sr=Math.floor(lbScrollPos),oy2=(lbScrollPos%1)*LB_ROW_H;
  for(let i=0;i<visRows+2;i++){
    const ri=sr+i;if(ri>=list.length)break;
    const en2=list[ri],ry=rowTop+i*LB_ROW_H-oy2;
    const isMe=currentUser&&en2.userId===currentUser.uid;
    if(isMe&&lbScrollDone){const p=0.5+Math.sin(victoryTimer*4)*0.5;ctx.fillStyle=`rgba(255,215,0,${0.1+p*0.1})`;ctx.shadowBlur=12;ctx.shadowColor='#ffd700';ctx.fillRect(px+4,ry,pw-8,LB_ROW_H-2);ctx.shadowBlur=0;}
    else if(ri<3){ctx.fillStyle=['rgba(255,215,0,0.06)','rgba(200,200,200,0.04)','rgba(180,100,30,0.04)'][ri];ctx.fillRect(px+4,ry,pw-8,LB_ROW_H-2);}
    const medal=ri===0?'ü•á':ri===1?'ü•à':ri===2?'ü•â':null;
    ctx.save();
    if(medal){ctx.font='16px serif';ctx.fillText(medal,px+12,ry+28);}
    else{ctx.font=`bold 13px 'Courier New'`;ctx.textAlign='left';ctx.fillStyle=isMe?'#ffd700':'rgba(255,255,255,0.45)';ctx.shadowBlur=isMe?5:0;ctx.shadowColor='#ffd700';ctx.fillText(`#${ri+1}`,px+10,ry+28);}
    ctx.restore();
    ctx.save();ctx.font=`${isMe?'bold ':''}13px 'Courier New'`;ctx.textAlign='left';ctx.fillStyle=isMe?'#fff':'rgba(255,255,255,0.65)';ctx.shadowBlur=isMe?4:0;ctx.shadowColor='#fff';ctx.fillText((en2.username||'Player').substring(0,14).toUpperCase()+(isMe?' ‚óÄ':''),px+56,ry+28);ctx.restore();
    ctx.save();ctx.font=`bold 15px 'Courier New'`;ctx.textAlign='right';ctx.fillStyle=isMe?'#ffd700':'#00ffff';ctx.shadowBlur=isMe?10:4;ctx.shadowColor=isMe?'#ffd700':'#00ffff';ctx.fillText((en2.score||0).toLocaleString(),px+pw-12,ry+28);
    ctx.font=`10px 'Courier New'`;ctx.fillStyle='rgba(255,255,255,0.28)';ctx.shadowBlur=0;ctx.fillText(`‚õì ${en2.flingCount||0}`,px+pw-12,ry+44);ctx.restore();
    ctx.save();ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(px+8,ry+LB_ROW_H-1);ctx.lineTo(px+pw-8,ry+LB_ROW_H-1);ctx.stroke();ctx.restore();
  }
  ctx.restore();
}

// ‚îÄ‚îÄ‚îÄ GAME STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ST={SPLASH:0,PLAY:1,DEAD:2,VICTORY:3,PAUSE:4};
let state=ST.SPLASH;
let chain,enemies,score,chainCount,flingCount;
let waveIdx,waveTimer,spawnTimer,waveLabel,waveLabelTimer;
let bestScore=parseInt(localStorage.getItem('cp_best')||'0');
let newRec=false,pendingRec=false,deathTimer=0,flashAlpha=0,bgT=0,lastTime=0;
let flingMult=1,flingStreak=0,flingKillCount=0,flingNum=0,bestFlingStreak=0; // scoring multipliers

const shareModal=document.getElementById('share-modal');
const shareCanvas=document.getElementById('share-canvas');
const shareCtx=shareCanvas.getContext('2d');

let lastTX=0,lastTY=0,pressing=false,swipeHistory=[];

const WAVES=[
  {name:'AWAKENING',  rate:2.8,types:[0],         max:6},
  {name:'RISING',     rate:2.2,types:[0,2],        max:8},
  {name:'PURSUIT',    rate:1.8,types:[0,1,2],      max:10},
  {name:'FRENZY',     rate:1.4,types:[0,2,3],      max:12},
  {name:'PANIC',      rate:1.1,types:[0,1,2,3,4],  max:14},
  {name:'MADNESS',    rate:0.85,types:[0,1,2,3,4,5],max:18},
  {name:'APOCALYPSE', rate:0.6,types:[0,1,2,3,4,5],max:22},
];

function initGame(){
  stopActiveStream(); // clean up any lingering streams
  chain=new Chain(W/2,H/2,9,22);
  enemies=[];P=[];FT=[];
  score=0;chainCount=0;flingCount=0;
  flingMult=1;flingStreak=0;flingKillCount=0;flingNum=0;bestFlingStreak=0;
  waveIdx=0;waveTimer=0;spawnTimer=0;waveLabel='';waveLabelTimer=0;
  flashAlpha=0;newRec=false;pendingRec=false;deathTimer=0;
  victoryTimer=0;lbLoaded=false;lbScrollDone=false;lbScrollPos=0;lastLbTickIdx=0;
  lbData={daily:[],weekly:[],allTime:[]};lbRank={daily:-1,weekly:-1,allTime:-1};
  // Keep videoBlob/URL until overwritten ‚Äî don't clear until new one ready
  bgT=bgT%628; // prevent float drift
  document.getElementById('btn-pause').classList.add('show');
  startBgMusic();
  startLiveRecord();
  showWave(0);
}
function showWave(i){waveLabel=`WAVE ${i+1}: ${WAVES[Math.min(i,WAVES.length-1)].name}`;waveLabelTimer=2.5;snd('wave');}
function spawnEnemy(){
  const w=WAVES[Math.min(waveIdx,WAVES.length-1)];
  if(enemies.filter(e=>!e.projectile).length>=w.max)return;
  const ti=w.types[Math.floor(Math.random()*w.types.length)],m=50,side=Math.floor(Math.random()*4);
  let x=W/2,y=H/2;
  if(side===0){x=Math.random()*W;y=-m;}else if(side===1){x=W+m;y=Math.random()*H;}
  else if(side===2){x=Math.random()*W;y=H+m;}else{x=-m;y=Math.random()*H;}
  enemies.push(new Enemy(ETYPES[ti],x,y));
}

// ‚îÄ‚îÄ‚îÄ COLLISIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkCollisions(){
  const tip=chain.tip,px=W/2,py=H/2,pR=20;
  enemies=enemies.filter(e=>{
    if(e.dead)return false;if(e.chained)return true;
    if(Math.sqrt((e.x-px)**2+(e.y-py)**2)<pR+e.sz){die();return false;}
    if(e.projectile)return true;
    const dx=e.x-tip.x,dy=e.y-tip.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d<chain.ballR+e.sz){
      e.hp--;
      if(e.hp<=0){
        snd('hit');shake(8);spark(e.x,e.y,e.col,14,5);
        if(chain.chained.length<MAX_CHAIN){if(e.bomb)e.fuseTimer=2.5;chain.addEnemy(e);e.chained=true;chainCount++;snd('chain');txt(e.x,e.y-24,'CHAINED!',e.col,16);}
        else{const bp=e.pts*2;score+=bp;spark(e.x,e.y,'#fff',10,6);txt(e.x,e.y-24,`FULL! +${bp}`,'#fff',18);}
      }else{spark(e.x,e.y,e.col,6,3);shake(4);}
      return e.hp>0&&!e.chained;
    }
    return true;
  });
  const proj=enemies.filter(e=>e.projectile),free=enemies.filter(e=>!e.projectile&&!e.chained);
  proj.forEach(p=>{free.forEach(e=>{
    if(e.dead)return;const dx=e.x-p.x,dy=e.y-p.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d<p.sz+e.sz){
      e.hp--;spark(e.x,e.y,e.col,14,5);
      if(e.hp<=0){
        if(flingKillCount===0){const ns=flingStreak+1;if(ns>bestFlingStreak)bestFlingStreak=ns;flingStreak=ns;} // first kill of fling ‚Üí streak up
        flingKillCount++;
        const tm=Math.max(1,flingMult+flingStreak);const pts=Math.round(e.pts*tm);score+=pts;flingCount++;
        const killTxt=tm>1?`${e.pts} x${tm}`:`+${pts}`;txt(e.x,e.y-22,killTxt,e.col,18);e.dead=true;shake(6);if(flingCount===5)txt(W/2,H*.84,'NICE SHOT!','#ffff00',34);if(flingCount===15)txt(W/2,H*.84,'ON FIRE!!','#ff6600',40);if(flingCount===30)txt(W/2,H*.84,'UNSTOPPABLE!!!','#ff44ff',46);}
      const spd=Math.sqrt(p.vx*p.vx+p.vy*p.vy)||0.001;if(spd<2.5){p.vx=p.vx/spd*2.5;p.vy=p.vy/spd*2.5;}
    }
  });});
  enemies=enemies.filter(e=>{if(e.dead)return false;if(e.projectile&&(e.x<-100||e.x>W+100||e.y<-100||e.y>H+100))return false;return true;});
}

// ‚îÄ‚îÄ‚îÄ BOMB EXPLOSIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkBombExplosions(){
  if(state!==ST.PLAY)return;
  const BLAST=85;
  enemies.forEach(e=>{
    if(!e.bomb||e.chained||e.projectile||e.dead||e.fuseTimer>0)return;
    e.dead=true;
    spark(e.x,e.y,'#ff6600',40,12);spark(e.x,e.y,'#ffcc00',20,8);spark(e.x,e.y,'#ffffff',12,6);
    shake(24);snd('bomb');txt(e.x,e.y-35,'BOOM!','#ff8800',38);
    // Blast ring visual
    FT.push({x:e.x,y:e.y,t:'',col:'#ff6600',sz:BLAST*2,life:0.6,vy:0,_ring:true,_r:0,_maxR:BLAST});
    // Check if either player ball is in blast radius
    const dTip=Math.hypot(chain.tip.x-e.x,chain.tip.y-e.y);
    const dCenter=Math.hypot(W/2-e.x,H/2-e.y);
    if(dTip<BLAST||dCenter<BLAST){die();return;}
    // Destroy nearby free enemies
    enemies.forEach(t=>{
      if(t===e||t.chained||t.projectile||t.dead)return;
      const d=Math.hypot(t.x-e.x,t.y-e.y);
      if(d<BLAST+t.sz){
        t.hp--;
        if(t.hp<=0){
          const tm=Math.max(1,flingMult+flingStreak);const pts=Math.round(t.pts*tm);
          score+=pts;spark(t.x,t.y,t.col,12,5);const bkillTxt=tm>1?`${t.pts} x${tm}`:`+${pts}`;txt(t.x,t.y-22,bkillTxt,t.col,18);t.dead=true;
        }
      }
    });
  });
  enemies=enemies.filter(e=>!e.dead); // cleanup exploded bombs + blast kills
}

function die(){
  if(state!==ST.PLAY&&state!==ST.PAUSE)return;
  stopBgMusic();
  document.getElementById('btn-pause').classList.remove('show');
  snd('death');shake(22);flashAlpha=1;spark(W/2,H/2,'#ff4400',30,7);
  const isNew=score>bestScore;
  if(isNew){bestScore=score;localStorage.setItem('cp_best',bestScore);newRec=true;}
  submitScore(bestScore,flingCount,bestFlingStreak); // always submit all-time best, not just current game
  captureFinalVideo(isNew?3500:2000,isNew); // victory: gameplay window + 3.5s of victory animation
  if(isNew){
    state=ST.VICTORY;victoryTimer=0;lbScrollDone=false;lbScrollPos=0;lastLbTickIdx=0;lbTab='daily';
    snd('victory');
    fetchLeaderboard().then(data=>{
      lbData=data;
      lbRank={daily:findPlayerRank(data.daily),weekly:findPlayerRank(data.weekly),allTime:findPlayerRank(data.allTime)};
      if(lbRank.daily>=0)lbTab='daily';else if(lbRank.weekly>=0)lbTab='weekly';else if(lbRank.allTime>=0)lbTab='allTime';
      lbLoaded=true;
    }).catch(()=>{lbLoaded=true;});
  }else{
    state=ST.DEAD;deathTimer=0;
  }
}

// ‚îÄ‚îÄ‚îÄ BG / PLAYER / HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawBG(){
  bgT+=0.012;
  ctx.fillStyle='#07070e';ctx.fillRect(0,0,W,H);
  ctx.save();ctx.strokeStyle='rgba(0,255,200,0.035)';ctx.lineWidth=1;
  const g=55,ox=(bgT*12)%g,oy=(bgT*8)%g;
  for(let x=-g+ox%g;x<W+g;x+=g){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=-g+oy%g;y<H+g;y+=g){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  ctx.restore();
  const vig=ctx.createRadialGradient(W/2,H/2,H*.25,W/2,H/2,H*.8);
  vig.addColorStop(0,'rgba(0,0,0,0)');vig.addColorStop(1,'rgba(0,0,15,.75)');
  ctx.fillStyle=vig;ctx.fillRect(0,0,W,H);
}
function drawPlayer(){
  const px=W/2,py=H/2,pulse=1+Math.sin(bgT*4)*.07;
  ctx.save();ctx.strokeStyle='rgba(0,200,255,0.25)';ctx.lineWidth=2;ctx.shadowBlur=12;ctx.shadowColor='#00ccff';ctx.beginPath();ctx.arc(px,py,34*pulse,0,Math.PI*2);ctx.stroke();
  const gr=ctx.createRadialGradient(px,py,0,px,py,20);
  gr.addColorStop(0,'#fff');gr.addColorStop(.4,'#88ddff');gr.addColorStop(1,'rgba(0,130,255,0)');
  ctx.shadowBlur=22;ctx.shadowColor='#00aaff';ctx.fillStyle=gr;ctx.beginPath();ctx.arc(px,py,20*pulse,0,Math.PI*2);ctx.fill();ctx.restore();
}
function drawHUD(){
  const safe=window.screen&&window.screen.height>812?44:20,pt=safe+10;
  ctx.save();ctx.font=`bold 16px 'Courier New'`;ctx.textAlign='left';ctx.fillStyle='rgba(255,255,255,.95)';ctx.shadowBlur=8;ctx.shadowColor='rgba(255,255,255,0.5)';ctx.fillText(`BEST ${bestScore}`,20,pt+18);ctx.restore();
  ctx.save();ctx.font=`bold 15px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='#00ffff';ctx.shadowBlur=10;ctx.shadowColor='#00ffff';ctx.fillText('SCORE',W/2,pt+16);ctx.font=`bold 46px 'Courier New'`;ctx.fillStyle='#fff';ctx.shadowBlur=22;ctx.shadowColor='#00ffff';ctx.fillText(score,W/2,pt+60);ctx.restore();
  ctx.save();const hc=chain.heat>.7?'#ff3300':chain.heat>.4?'#ff8800':'#ffaa00';ctx.font=`bold 15px 'Courier New'`;ctx.textAlign='right';ctx.fillStyle='rgba(255,170,0,1)';ctx.shadowBlur=8;ctx.shadowColor='#ffaa00';ctx.fillText('CHAIN',W-20,pt+16);ctx.font=`bold 30px 'Courier New'`;ctx.fillStyle=hc;ctx.shadowBlur=16;ctx.shadowColor=hc;ctx.fillText(`‚õì ${chain.chained.length}/${MAX_CHAIN}`,W-20,pt+46);
  const bw=80,bh=7,bx=W-20-bw,by=pt+54;ctx.fillStyle='rgba(255,255,255,.12)';ctx.fillRect(bx,by,bw,bh);
  const hg=ctx.createLinearGradient(bx,by,bx+bw,by);hg.addColorStop(0,'#00ff88');hg.addColorStop(.5,'#ffaa00');hg.addColorStop(1,'#ff2200');ctx.fillStyle=hg;ctx.shadowBlur=chain.heat>.6?10:0;ctx.shadowColor='#ff4400';ctx.fillRect(bx,by,bw*chain.heat,bh);ctx.font=`bold 13px 'Courier New'`;ctx.fillStyle='rgba(255,255,255,.6)';ctx.shadowBlur=0;ctx.fillText('HEAT',W-20,by+bh+14);ctx.restore();
  if(waveLabelTimer>0){const a=Math.min(1,waveLabelTimer)*Math.min(1,waveLabelTimer/.4);ctx.save();ctx.globalAlpha=a;ctx.font=`bold 26px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='#00ffff';ctx.shadowBlur=18;ctx.shadowColor='#00ffff';ctx.fillText(waveLabel,W/2,H/2+90);ctx.restore();}

  if(chain.chained.length>=2&&flingCount===0){const p=.5+Math.sin(bgT*5)*.5;ctx.save();ctx.globalAlpha=p*.9;ctx.font=`14px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='#00ffff';ctx.shadowBlur=8;ctx.shadowColor='#00ffff';ctx.fillText('FAST SWIPE TO FLING!',W/2,H-50);ctx.restore();}
  // ‚îÄ‚îÄ‚îÄ HUD: CHAIN + STREAK (bottom-right) ‚îÄ‚îÄ‚îÄ
  ctx.save();ctx.textAlign='right';
  // CHAIN ‚Äî cyan, steady
  const chainSz=chain.chained.length;
  ctx.globalAlpha=chainSz>0?0.9:0.25;
  ctx.font=`bold ${chainSz>0?22:16}px 'Courier New'`;
  ctx.fillStyle='#00ffff';ctx.shadowBlur=chainSz>0?10:0;ctx.shadowColor='#00ffff';
  ctx.fillText(`CHAIN x${chainSz}`,W-16,H-48);
  // STREAK ‚Äî x1 matches chain size, grows beyond that, flashes at 10+
  const sk=flingStreak;
  let skCol,skSz,skAlpha,skBlur;
  if(sk===0){skCol='rgba(255,255,255,0.4)';skSz=16;skAlpha=0.3;skBlur=0;}
  else if(sk===1){skCol='#ffaa00';skSz=22;skAlpha=0.9;skBlur=8;}
  else if(sk<=3){skCol='#ffaa00';skSz=24;skAlpha=0.9;skBlur=10;}
  else if(sk<=6){skCol='#ff7700';skSz=28;skAlpha=0.95;skBlur=16;}
  else if(sk<=9){skCol='#ff3300';skSz=32;skAlpha=1;skBlur=22;}
  else{const fl=Math.sin(bgT*14)>0;skCol=fl?'#ff0000':'#ffcc00';skSz=36;skAlpha=1;skBlur=28+Math.abs(Math.sin(bgT*14))*12;}
  ctx.globalAlpha=sk>=10?1:(sk>0?(0.75+Math.sin(bgT*6)*0.25):skAlpha);
  ctx.font=`bold ${skSz}px 'Courier New'`;
  ctx.fillStyle=skCol;ctx.shadowBlur=skBlur;ctx.shadowColor=skCol;
  ctx.fillText(`STREAK x${sk}`,W-16,H-18);
  ctx.restore();
}

// ‚îÄ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let splashT=0;
function drawSplash(){
  splashT+=.016;drawBG();
  // ‚îÄ‚îÄ Title
  const fs=Math.min(W*.13,72);ctx.save();const pulse=1+Math.sin(splashT*2)*.02;ctx.scale(pulse,pulse);
  ctx.font=`bold ${fs}px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='#fff';ctx.shadowBlur=28;ctx.shadowColor='#00ffff';ctx.fillText('CHAIN',(W/2)/pulse,(H/2-120)/pulse);
  ctx.fillStyle='#ffaa00';ctx.shadowColor='#ff5500';ctx.fillText('PANIC',(W/2)/pulse,(H/2-120+fs*1.05)/pulse);ctx.restore();
  // ‚îÄ‚îÄ TAP TO PLAY
  if(Math.sin(splashT*3)>0){ctx.save();ctx.font=`bold 16px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='rgba(255,255,255,.9)';ctx.shadowBlur=10;ctx.shadowColor='#fff';ctx.fillText('‚ñ∂  TAP TO PLAY',W/2,H/2+60);ctx.restore();}
  // ‚îÄ‚îÄ LEADERBOARD button
  const lbY=H/2+105;
  ctx.save();ctx.fillStyle='rgba(0,255,255,0.1)';roundRect(ctx,W/2-95,lbY-22,190,44,12);ctx.fill();
  ctx.strokeStyle='rgba(0,255,255,0.55)';ctx.lineWidth=2;roundRect(ctx,W/2-95,lbY-22,190,44,12);ctx.stroke();
  ctx.font=`bold 15px 'Courier New'`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle='#00ffff';ctx.shadowBlur=0;ctx.fillText('LEADERBOARD',W/2,lbY);ctx.textBaseline='alphabetic';ctx.restore();
  // ‚îÄ‚îÄ SETTINGS button
  const stY=H/2+160;
  ctx.save();ctx.fillStyle='rgba(255,255,255,0.06)';roundRect(ctx,W/2-95,stY-22,190,44,12);ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=2;roundRect(ctx,W/2-95,stY-22,190,44,12);ctx.stroke();
  ctx.font=`bold 15px 'Courier New'`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle='rgba(255,255,255,0.85)';ctx.shadowBlur=0;ctx.fillText('SETTINGS',W/2,stY);ctx.textBaseline='alphabetic';ctx.restore();
  // ‚îÄ‚îÄ Chain animation ‚Äî drawn LAST so it floats above buttons (no tap zone impact)
  ctx.save();const cx=W/2,cy=H/2-10;
  for(let i=0;i<10;i++){
    const t=splashT*1.3+i*.38,nx=cx+Math.cos(t)*(55+i*7),ny=cy+Math.sin(t*.75)*45+i*10;
    ctx.strokeStyle=`hsla(${175+i*8},100%,65%,${.35+Math.sin(t)*.15})`;ctx.lineWidth=3;ctx.shadowBlur=7;ctx.shadowColor=ctx.strokeStyle;
    if(i>0){const pt2=splashT*1.3+(i-1)*.38,px2=cx+Math.cos(pt2)*(55+(i-1)*7),py2=cy+Math.sin(pt2*.75)*45+(i-1)*10;ctx.beginPath();ctx.moveTo(px2,py2);ctx.lineTo(nx,ny);ctx.stroke();}
    ctx.fillStyle=i===9?'#ffdd00':'#888';ctx.shadowColor=i===9?'#ff8800':'#888';ctx.shadowBlur=i===9?14:5;ctx.beginPath();ctx.arc(nx,ny,i===9?12:3.5,0,Math.PI*2);ctx.fill();
  }ctx.restore();
  // ‚îÄ‚îÄ HOW TO PLAY
  const hp=.4+Math.sin(splashT*2.5)*.6;
  ctx.save();ctx.globalAlpha=hp;ctx.font=`bold 15px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='rgba(0,255,255,0.85)';ctx.shadowBlur=8;ctx.shadowColor='#00ffff';ctx.fillText('‚ùì HOW TO PLAY',W/2,H-32);ctx.restore();
  drawP();drawFT();
}
function roundRect(c,x,y,w,h,r){c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.arcTo(x+w,y,x+w,y+r,r);c.lineTo(x+w,y+h-r);c.arcTo(x+w,y+h,x+w-r,y+h,r);c.lineTo(x+r,y+h);c.arcTo(x,y+h,x,y+h-r,r);c.lineTo(x,y+r);c.arcTo(x,y,x+r,y,r);c.closePath();}

// ‚îÄ‚îÄ‚îÄ DEAD SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawDead(){
  drawBG();enemies.forEach(e=>{if(!e.chained)e.draw();});
  // Player behind chain ‚Äî consistent with play state
  drawPlayer();chain.draw();
  drawP();drawFT();
  if(flashAlpha>0){ctx.save();ctx.globalAlpha=flashAlpha;ctx.fillStyle='#ff1100';ctx.fillRect(0,0,W,H);flashAlpha-=.05;ctx.restore();}
  const ov=Math.min(1,deathTimer/1.2);ctx.save();ctx.globalAlpha=ov*.75;ctx.fillStyle='#000010';ctx.fillRect(0,0,W,H);ctx.restore();
  if(deathTimer<.4)return;
  const a=Math.min(1,(deathTimer-.4)*2.5);ctx.save();ctx.globalAlpha=a;
  const fs=Math.min(W*.135,70);ctx.font=`bold ${fs}px 'Courier New'`;ctx.textAlign='center';ctx.fillStyle='#ff2200';ctx.shadowBlur=35;ctx.shadowColor='#ff0000';ctx.fillText('GAME',W/2,H/2-55);ctx.fillText('OVER',W/2,H/2+10);
  ctx.font=`bold 26px 'Courier New'`;ctx.fillStyle='#fff';ctx.shadowColor='#00ffff';ctx.shadowBlur=12;ctx.fillText(`SCORE: ${score}`,W/2,H/2+65);
  ctx.font=`15px 'Courier New'`;ctx.fillStyle='#ffaa00';ctx.shadowColor='#ffaa00';ctx.shadowBlur=8;ctx.fillText(`FLUNG: ${flingCount}  ‚Ä¢  BEST STREAK: x${bestFlingStreak}`,W/2,H/2+92);
  if(newRec){const rp=Math.round(20*(1+Math.sin(deathTimer*6)*.05));ctx.font=`bold ${rp}px 'Courier New'`;ctx.fillStyle='#ffff00';ctx.shadowColor='#ffff00';ctx.shadowBlur=22;ctx.fillText('üèÜ NEW RECORD!',W/2,H/2+122);}
  const interactive=videoBlob||deathTimer>2.5;
  if(interactive){
    // TAP TO RETRY ‚Äî slightly below very top so it has breathing room
    if(Math.sin(deathTimer*4)>0){ctx.font=`bold 16px 'Courier New'`;ctx.fillStyle='rgba(255,255,255,.9)';ctx.shadowBlur=8;ctx.shadowColor='#fff';ctx.fillText('‚ñ∂  TAP TO RETRY',W/2,H*0.17);}
    // SHARE
    const sp=0.7+Math.sin(deathTimer*3)*0.3;ctx.save();ctx.globalAlpha=sp;ctx.font=`bold 17px 'Courier New'`;ctx.fillStyle='#00ffff';ctx.shadowColor='#00ffff';ctx.shadowBlur=18;ctx.fillText('[ SHARE YOUR SCORE ]',W/2,H/2+(newRec?186:168));ctx.restore();
    // LEADERBOARD
    const lp=0.5+Math.sin(deathTimer*2.8)*0.2;ctx.save();ctx.globalAlpha=lp;ctx.font=`bold 17px 'Courier New'`;ctx.fillStyle='#ffdd44';ctx.shadowColor='#ffaa00';ctx.shadowBlur=14;ctx.fillText('[ LEADERBOARD ]',W/2,H/2+(newRec?222:204));ctx.restore();
    // HOME
    const hp2=0.5+Math.sin(deathTimer*2.5)*0.2;ctx.save();ctx.globalAlpha=hp2;ctx.font=`bold 17px 'Courier New'`;ctx.fillStyle='rgba(255,255,255,0.7)';ctx.shadowBlur=0;ctx.fillText('[ HOME ]',W/2,H/2+(newRec?258:240));ctx.restore();
  }ctx.restore();
}

// ‚îÄ‚îÄ‚îÄ PAUSE SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pauseT=0;
function drawPause(){
  pauseT+=0.016;
  ctx.save();ctx.fillStyle='rgba(0,0,10,0.72)';ctx.fillRect(0,0,W,H);
  const pulse=1+Math.sin(pauseT*2.5)*.04;
  ctx.save();ctx.translate(W/2,H/2-30);ctx.scale(pulse,pulse);
  ctx.font=`bold ${Math.min(W*.14,68)}px 'Courier New'`;ctx.textAlign='center';
  ctx.shadowBlur=30;ctx.shadowColor='#00ffff';ctx.fillStyle='#00ffff';ctx.fillText('PAUSED',0,0);ctx.restore();
  ctx.restore();
}

// ‚îÄ‚îÄ‚îÄ SHARE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function canvasToBlob(cvs){const d=cvs.toDataURL('image/png'),bstr=atob(d.split(',')[1]);let n=bstr.length;const u8=new Uint8Array(n);while(n--)u8[n]=bstr.charCodeAt(n);return new Blob([u8],{type:'image/png'});}
function buildCard(){
  const sc=shareCanvas,sx=shareCtx,sw=sc.width,sh=sc.height;
  sx.fillStyle='#07070e';sx.fillRect(0,0,sw,sh);sx.strokeStyle='rgba(0,255,200,.06)';sx.lineWidth=1;
  for(let x=0;x<sw;x+=38){sx.beginPath();sx.moveTo(x,0);sx.lineTo(x,sh);sx.stroke();}
  for(let y=0;y<sh;y+=38){sx.beginPath();sx.moveTo(0,y);sx.lineTo(sw,y);sx.stroke();}
  const tg=sx.createLinearGradient(0,0,sw,0);tg.addColorStop(0,'#00ffff22');tg.addColorStop(.5,'#ff000022');tg.addColorStop(1,'#ffaa0022');sx.fillStyle=tg;sx.fillRect(0,0,sw,4);
  sx.font=`bold 50px 'Courier New'`;sx.textAlign='center';sx.fillStyle='#fff';sx.shadowBlur=20;sx.shadowColor='#00ffff';sx.fillText('CHAIN',sw*.36,70);sx.fillStyle='#ffaa00';sx.shadowColor='#ff5500';sx.fillText('PANIC',sw*.65,70);
  sx.strokeStyle='rgba(0,255,255,.2)';sx.lineWidth=1;sx.beginPath();sx.moveTo(30,90);sx.lineTo(sw-30,90);sx.stroke();
  [{l:'SCORE',v:String(score),c:'#fff',big:true},{l:'ENEMIES FLUNG',v:String(flingCount),c:'#ff88ff',big:false},{l:'BEST STREAK',v:`x${bestFlingStreak}`,c:'#ffaa00',big:false},{l:'PERSONAL BEST',v:String(bestScore),c:'#00ffff',big:false}].forEach((s,i)=>{const x=30+(i%2)*(sw/2),y=110+Math.floor(i/2)*80;sx.textAlign='left';sx.font=`10px 'Courier New'`;sx.fillStyle='rgba(255,255,255,.4)';sx.shadowBlur=0;sx.fillText(s.l,x,y);sx.font=`bold ${s.big?40:28}px 'Courier New'`;sx.fillStyle=s.c;sx.shadowBlur=12;sx.shadowColor=s.c;sx.fillText(s.v,x,y+(s.big?42:34));});
  sx.font=`11px 'Courier New'`;sx.textAlign='center';sx.shadowBlur=0;sx.fillStyle='rgba(0,255,255,0.55)';sx.fillText(GAME_URL,sw/2,sh-32);
  if(newRec){sx.fillStyle='rgba(255,220,0,0.13)';sx.fillRect(0,sh-52,sw,22);sx.font=`bold 13px 'Courier New'`;sx.textAlign='center';sx.fillStyle='#ffff00';sx.shadowColor='#ffee00';sx.shadowBlur=14;sx.fillText('üèÜ  NEW PERSONAL RECORD!',sw/2,sh-35);}
  else{sx.font=`12px 'Courier New'`;sx.textAlign='center';sx.fillStyle='rgba(0,255,255,.3)';sx.shadowBlur=0;sx.fillText('#ChainPanic',sw/2,sh-14);}
}
function openShareModal(){
  const vid=document.getElementById('share-video');
  const wrap=document.getElementById('video-wrap');
  const rec=document.getElementById('share-rec');
  const img=document.getElementById('share-img');
  const btn=document.getElementById('btn-sn');
  const copyBtn=document.getElementById('btn-copy');
  copyBtn.style.display=navigator.share?'none':'';
  btn.innerHTML='<span>SHARE</span>';
  // Hide all previews
  shareCanvas.style.display='none';wrap.style.display='none';rec.style.display='none';img.style.display='none';
  function showVideo(){
    vid.src=videoURL;vid.load();vid.play().catch(()=>{});
    rec.style.display='none';wrap.style.display='block';
    btn.disabled=false;btn.classList.remove('loading');btn.classList.add('ready');
  }
  function showScreenshot(){
    // Full-size screenshot of the actual game canvas
    try{img.src=canvas.toDataURL('image/jpeg',0.88);img.style.display='block';}
    catch(e){buildCard();shareCanvas.style.display='block';}
    btn.disabled=false;btn.classList.remove('loading');btn.classList.add('ready');
  }
  if(!window.MediaRecorder||!canvas.captureStream){
    // No recording support ‚Äî show screenshot immediately
    showScreenshot();
  } else if(videoBlob){
    showVideo();
  } else {
    // Recording in progress ‚Äî show loading indicator, poll for completion
    rec.style.display='block';
    btn.disabled=true;btn.classList.add('loading');btn.classList.remove('ready');
    const poll=setInterval(()=>{
      if(videoBlob){clearInterval(poll);showVideo();}
    },300);
  }
  shareModal.classList.add('show');
}
function shareText(){return `I scored ${score} in CHAIN PANIC ‚Äî ${flingCount} enemies flung! ‚õì‚ö° Play free: ${GAME_URL} #ChainPanic`;}
function copyClip(t){
  if(navigator.clipboard){navigator.clipboard.writeText(t).then(()=>{const b=document.getElementById('btn-copy');const prev=b.textContent;b.textContent='COPIED!';setTimeout(()=>b.textContent=prev,1800);});}
  else{try{prompt('Copy this:',t);}catch(e){}}
}
function doShare(){
  // Build share data synchronously to preserve user gesture for repeat taps
  const st=shareText();
  const data={title:'Chain Panic',text:st};
  if(videoBlob){
    try{
      const ext=videoBlob.type.includes('mp4')?'mp4':'webm';
      const vf=new File([videoBlob],'chain-panic.'+ext,{type:videoBlob.type});
      if(navigator.canShare&&navigator.canShare({files:[vf]}))data.files=[vf];
    }catch(e){}
  }
  if(!data.files){
    buildCard();
    try{
      const img=new File([canvasToBlob(shareCanvas)],'chain-panic.png',{type:'image/png'});
      if(navigator.canShare&&navigator.canShare({files:[img]}))data.files=[img];
    }catch(e){}
  }
  if(!data.files)data.url=GAME_URL;
  if(navigator.share){
    navigator.share(data).catch(e=>{if(e.name!=='AbortError')copyClip(st);});
  }else{
    copyClip(st);
  }
}

document.getElementById('btn-sn').addEventListener('click',doShare);
document.getElementById('btn-copy').addEventListener('click',()=>copyClip(shareText()));
document.getElementById('btn-cl').addEventListener('click',()=>{shareModal.classList.remove('show');document.getElementById('share-video').pause();});
document.getElementById('btn-pause').addEventListener('click',e=>{
  e.stopPropagation();
  if(state===ST.PLAY){state=ST.PAUSE;stopBgMusic();e.currentTarget.textContent='RESUME';}
  else if(state===ST.PAUSE){state=ST.PLAY;lastTime=performance.now();startBgMusic();e.currentTarget.textContent='PAUSE';}
});

// ‚îÄ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getTap(e){return e.touches?e.touches[0]:e;}
function onStart(e){
  e.preventDefault();initAudio();
  const t=getTap(e);lastTX=t.clientX;lastTY=t.clientY;pressing=true;
  swipeHistory=[[t.clientX,t.clientY,performance.now()]];
  if(state===ST.PAUSE){state=ST.PLAY;lastTime=performance.now();startBgMusic();document.getElementById('btn-pause').textContent='PAUSE';return;}
  if(state===ST.SPLASH){
    if(t.clientY>H-50){document.getElementById('how-modal').classList.add('show');return;}
    // LEADERBOARD button zone
    const lbY=H/2+105;
    if(t.clientX>W/2-95&&t.clientX<W/2+95&&t.clientY>lbY-22&&t.clientY<lbY+22){openLeaderboard();return;}
    // SETTINGS button zone
    const stY=H/2+160;
    if(t.clientX>W/2-95&&t.clientX<W/2+95&&t.clientY>stY-22&&t.clientY<stY+22){openSettings();return;}
    state=ST.PLAY;initGame();return;
  }
  if(state===ST.DEAD&&(videoBlob||deathTimer>2.5)){
    const shareY=H/2+(newRec?186:168);
    const lbDeadY=H/2+(newRec?222:204);
    const homeY=H/2+(newRec?258:240);
    if(t.clientY>homeY-24&&t.clientY<homeY+24){state=ST.SPLASH;return;}
    if(t.clientY>lbDeadY-24&&t.clientY<lbDeadY+24){openLeaderboard();return;}
    if(t.clientY>shareY-22&&t.clientY<shareY+22){openShareModal();return;}
    state=ST.PLAY;initGame();return;
  }
  if(state===ST.VICTORY&&victoryTimer>10){
    // HOME button (drawn at H-44, rect H-64 to H-28)
    if(t.clientY>H-72&&t.clientY<H-24){state=ST.SPLASH;return;}
    // Share prompt (drawn at H-80)
    if(t.clientY>H-110&&t.clientY<=H-72){openShareModal();return;}
    if(t.clientY<H*0.25){state=ST.PLAY;initGame();return;}
    // Tab taps
    if(victoryTimer>3.5){
      const pw=Math.min(400,W-40),ph=H*0.84,px=(W-pw)/2,panY=H-ph,tw=pw/3,ty=panY+34;
      const tabs=['daily','weekly','allTime'];
      for(let i=0;i<3;i++){const tx=px+i*tw;if(t.clientX>=tx&&t.clientX<=tx+tw&&t.clientY>=ty&&t.clientY<=ty+22){lbTab=tabs[i];lbScrollPos=0;lbScrollDone=false;lastLbTickIdx=0;return;}}
    }
  }
}
function onMove(e){
  e.preventDefault();if(!pressing||state!==ST.PLAY)return;
  const t=getTap(e),dx=t.clientX-lastTX,dy=t.clientY-lastTY;
  chain.svx+=dx*14;chain.svy+=dy*14;
  swipeHistory.push([t.clientX,t.clientY,performance.now()]);
  if(swipeHistory.length>12)swipeHistory.shift();
  lastTX=t.clientX;lastTY=t.clientY;
}
function onEnd(e){
  e.preventDefault();if(!pressing)return;pressing=false;
  if(state===ST.PLAY&&chain.chained.length>0&&swipeHistory.length>=3){
    const r=swipeHistory.slice(-4),dt2=(r[r.length-1][2]-r[0][2])/1000;
    const ddx=r[r.length-1][0]-r[0][0],ddy=r[r.length-1][1]-r[0][1];
    const sp=Math.sqrt(ddx*ddx+ddy*ddy)/(dt2||.016);
    if(sp>600){
      const vx=ddx/(dt2||.016)*.012,vy=ddy/(dt2||.016)*.012;
      const launched=chain.fling(vx,vy);launched.forEach(e=>enemies.push(e));flingCount+=launched.length;
      if(launched.length>0){
        // If previous fling got zero kills ‚Üí streak broken, mult resets to 1
        const wasMiss=flingNum>0&&flingKillCount===0;
        if(wasMiss)flingStreak=0;
        flingNum++;flingKillCount=0;
        flingMult=wasMiss?1:launched.length; // x1 on miss, chain-size bonus otherwise
        shake(10+launched.length*3);spark(chain.tip.x,chain.tip.y,'#00ffff',16,7);
      }
    }
  }
  swipeHistory=[];
}
canvas.addEventListener('touchstart',onStart,{passive:false});
canvas.addEventListener('touchmove',onMove,{passive:false});
canvas.addEventListener('touchend',onEnd,{passive:false});
canvas.addEventListener('mousedown',onStart);
canvas.addEventListener('mousemove',onMove);
canvas.addEventListener('mouseup',onEnd);
document.body.addEventListener('touchmove',e=>{if(e.target.tagName!=='INPUT')e.preventDefault();},{passive:false});

// ‚îÄ‚îÄ‚îÄ MAIN LOOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loop(ts){
  const dt=state===ST.PAUSE?0:Math.min((ts-lastTime)/1000,.05);
  if(state!==ST.PAUSE)lastTime=ts;
  ctx.clearRect(0,0,W,H);ctx.save();ctx.translate(SX,SY);
  if(state===ST.SPLASH){drawSplash();updateP(dt);}
  else if(state===ST.PLAY){
    drawBG();
    waveTimer+=dt;if(waveLabelTimer>0)waveLabelTimer-=dt;
    if(waveTimer>20&&waveIdx<WAVES.length-1){waveIdx++;waveTimer=0;showWave(waveIdx);}
    spawnTimer+=dt;const w=WAVES[Math.min(waveIdx,WAVES.length-1)];if(spawnTimer>w.rate){spawnEnemy();spawnTimer=0;}
    chain.update(dt,W/2,H/2);enemies.forEach(e=>e.update(dt,W/2,H/2,chain.tip.x,chain.tip.y));
    checkCollisions();checkBombExplosions();
    // If fling had zero kills and all projectiles are gone ‚Üí miss confirmed, reset streak now
    if(flingNum>0&&flingKillCount===0&&!enemies.some(e=>e.projectile)){flingStreak=0;}
    updateP(dt);updateFT(dt);updateShake(dt);
    if(chain.heat>=1&&chain.chained.length>0){chain.snap();flingStreak=0;flingMult=1;flingKillCount=0;}
    enemies.forEach(e=>{if(!e.chained)e.draw();});
    drawPlayer();chain.draw();
    drawP();drawFT();drawHUD();
  }
  else if(state===ST.PAUSE){
    drawBG();enemies.forEach(e=>{if(!e.chained)e.draw();});
    drawPlayer();chain.draw();drawP();drawFT();drawHUD();drawPause();
  }
  else if(state===ST.DEAD){deathTimer+=dt;updateP(dt);updateFT(dt);updateShake(dt);drawDead();}
  else if(state===ST.VICTORY){drawVictory(dt);}
  ctx.restore();requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initAuth();
requestAnimationFrame(t=>{lastTime=t;requestAnimationFrame(loop);});
</script>
</body>
</html>
